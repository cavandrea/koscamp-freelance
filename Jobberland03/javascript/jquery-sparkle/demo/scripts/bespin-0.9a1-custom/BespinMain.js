bespin.tiki.register("::text_editor",{name:"text_editor",dependencies:{completion:"0.0.0",undomanager:"0.0.0",settings:"0.0.0",canon:"0.0.0",rangeutils:"0.0.0",traits:"0.0.0",theme_manager:"0.0.0",keyboard:"0.0.0",edit_session:"0.0.0",syntax_manager:"0.0.0"}});
bespin.tiki.module("text_editor:commands/editing",function(q,m){var o=q("settings").settings,k=q("environment").env,h=q("rangeutils:utils/range");m.backspace=function(){k.view.performBackspaceOrDelete(true)};m.deleteCommand=function(){k.view.performBackspaceOrDelete(false)};m.deleteLines=function(){if(!k.model.readOnly)if(k.model.lines.length!=1){var a=k.view;a.groupChanges(function(){var b=a.getSelectedRange(),i=k.model.lines,f=i.length-1,d;d=b.start.row==f?{col:i[f-1].length,row:f-1}:{col:0,row:b.start.row};
a.replaceCharacters({start:d,end:b.end.row==f?{col:i[f].length,row:f}:{col:0,row:b.end.row+1}},"");a.moveCursorTo(d)})}};var e=function(a,b){var i=b.getSelectedRange().start;a=/^\s*/.exec(a.lines[i.row].substring(0,i.col));b.insertText("\n"+a)};m.insertText=function(a){k.view.insertText(a.text)};m.newline=function(){e(k.model,k.view)};m.joinLines=function(){var a=k.model;if(!a.readOnly){var b=k.view,i=b.getSelectedRange(),f=a.lines,d=i.end.row;f.length!=d&&b.groupChanges(function(){b.replaceCharacters({start:{col:f[d].length,
row:d},end:{col:/^\s*/.exec(f[d+1])[0].length,row:d+1}},"")})}};m.openLine=function(){if(!k.model.readOnly){var a=k.model,b=k.view,i=b.getSelectedRange().end.row;b.moveCursorTo({row:i,col:a.lines[i].length});e(a,b)}};m.tab=function(){var a=k.view;a.groupChanges(function(){var b=o.get("tabstop"),i=a.getSelectedRange(),f="";if(h.isZeroLength(i)){var d=k.model.lines[i.start.row].substring(i.start.col).match(/^\s*/)[0].length;b=b-(i.start.col+d)%b;for(var g=0;g<b;g++)f+=" ";a.replaceCharacters({start:i.start,
end:i.start},f);a.moveCursorTo({col:i.start.col+b+d,row:i.end.row})}else{for(g=0;g<b;g++)f+=" ";for(g=i.start.row-1;g++<i.end.row;){d=g==i.start.row?i.start.col:0;a.replaceCharacters({start:{row:g,col:d},end:{row:g,col:d}},f)}a.setSelection({start:i.start,end:{col:i.end.col+b,row:i.end.row}})}}.bind(this))};m.untab=function(){var a=k.view;a.groupChanges(function(){var b=o.get("tabstop"),i=a.getSelectedRange(),f=k.model.lines,d=0;if(h.isZeroLength(i)){d=Math.min(f[i.start.row].substring(0,i.start.col).match(/\s*$/)[0].length,
(i.start.col-b)%b||b);a.replaceCharacters({start:{col:i.start.col-d,row:i.start.row},end:i.start},"");a.moveCursorTo({row:i.start.row,col:i.end.col-d})}else{for(var g,j=i.start.row-1;j++<i.end.row;){g=j==i.start.row?i.start.col:0;d=Math.min(f[j].substring(g).match(/^\s*/)[0].length,b);a.replaceCharacters({start:{row:j,col:g},end:{row:j,col:g+d}},"")}a.setSelection({start:{row:i.start.row,col:i.start.col},end:{row:i.end.row,col:i.end.col-d}})}}.bind(this))}});
bespin.tiki.module("text_editor:commands/editor",function(q,m){q("bespin:plugins");var o=q("settings").settings,k=q("environment").env;m.findNextCommand=function(){var e=k.view,a=e.editor.searchController,b=e.getSelectedRange();if(a=a.findNext(b.end,true)){e.setSelection(a,true);e.focus()}};m.findPrevCommand=function(){var e=k.view,a=e.editor.searchController,b=e.getSelectedRange();if(a=a.findPrevious(b.start,true)){e.setSelection(a,true);e.focus()}};var h=function(e){var a=k.view,b=a.getSelectedCharacters();
e=e(b);a=a.getSelectedRange();k.model.replaceCharacters(a,e)};m.replaceCommand=function(e){h(function(a){return a.replace(e.search+"/g",e.replace)})};m.entabCommand=function(){tabstop=o.get("tabstop");h(function(e){return e.replace(" {"+tabstop+"}","\t")})};m.detabCommand=function(){tabstop=o.get("tabstop");h(function(e){return e.replace("\t",(new Array(tabstop+1)).join(" "))})};m.trimCommand=function(e){h(function(a){a=a.split("\n");a=a.map(function(b){if(e.side==="left"||e.side==="both")b=b.replace(/^\s+/,
"");if(e.side==="right"||e.side==="both")b=b.replace(/\s+$/,"");return b});return a.join("\n")})};m.ucCommand=function(){h(function(e){return e.toUpperCase()})};m.lcCommand=function(){h(function(e){return e.toLowerCase()})}});
bespin.tiki.module("text_editor:commands/movement",function(q,m){q("rangeutils:utils/range");var o=q("environment").env;m.moveDown=function(){o.view.moveDown()};m.moveLeft=function(){o.view.moveLeft()};m.moveRight=function(){o.view.moveRight()};m.moveUp=function(){o.view.moveUp()};m.selectDown=function(){o.view.selectDown()};m.selectLeft=function(){o.view.selectLeft()};m.selectRight=function(){o.view.selectRight()};m.selectUp=function(){o.view.selectUp()};var k=function(i,f){var d=o.view,g=o.model.lines,
j=d.getSelectedRange(true);f=f?j.end.row:g.length-1;d.moveCursorTo({row:f,col:g[f].length},i)};m.moveLineEnd=function(){k(false,true)};m.selectLineEnd=function(){k(true,true)};m.moveDocEnd=function(){k(false,false)};m.selectDocEnd=function(){k(true,false)};var h=function(i,f){var d=o.view,g=d.getSelectedRange(true);d.moveCursorTo({row:f?g.end.row:0,col:0},i)};m.moveLineStart=function(){h(false,true)};m.selectLineStart=function(){h(true,true)};m.moveDocStart=function(){h(false,false)};m.selectDocStart=
function(){h(true,false)};var e=function(i,f,d,g,j){var n=0,r=false;if(g<0){d--;if(j)n=1}for(;d<f.length&&d>-1;){if(j=i.isDelimiter(f[d]))n++;else r=true;if((j||n>1)&&r)break;d+=g}g<0&&d++;return d},a=function(i){var f=o.view,d=o.model.lines,g=f.getSelectedRange(true).end,j=g.row;g=g.col;var n=d[j],r=false;if(g>=n.length){j++;r=true;if(j<d.length){g=0;n=d[j]}else n=""}g=e(f,n,g,1,r);f.moveCursorTo({row:j,col:g},i)},b=function(i){var f=o.view,d=o.model.lines,g=f.getSelectedRange(true).end,j=g.row;
g=g.col;var n=d[j],r=false;if(g>n.length)g=n.length;else if(g==0){j--;r=true;if(j>-1){n=d[j];g=n.length}else n=""}g=e(f,n,g,-1,r);f.moveCursorTo({row:j,col:g},i)};m.moveNextWord=function(){a(false)};m.selectNextWord=function(){a(true)};m.movePreviousWord=function(){b(false)};m.selectPreviousWord=function(){b(true)};m.selectAll=function(){o.view.selectAll()}});
bespin.tiki.module("text_editor:commands/scrolling",function(q,m){var o=q("environment").env;m.scrollDocStart=function(){o.view.scrollToPosition({col:0,row:0})};m.scrollDocEnd=function(){o.view.scrollToPosition(o.model.range.end)};m.scrollPageDown=function(){o.view.scrollPageDown()};m.scrollPageUp=function(){o.view.scrollPageUp()}});
bespin.tiki.module("text_editor:controllers/layoutmanager",function(q,m){var o=q("bespin:util/util"),k=q("events").Event;q("rangeutils:utils/range");var h=q("syntax_manager").SyntaxManager,e=q("models/textstorage").TextStorage,a=q("bespin:plugins").catalog,b=q("settings").settings,i=q("bespin:util/scratchcanvas"),f={};q=function(){var d=b.get("fontsize"),g=b.get("fontface");g=d+"px "+g;for(var j=i.get(),n="",r=0;r<100;r++)n+="M";g=j.measureStringWidth(g,n)/100;f.characterWidth=g;f.lineHeight=Math.floor(d*
1.6);f.lineAscent=Math.floor(d*1.3)};q();a.registerExtension("settingChange",{match:"font[size|face]",pointer:q});m.LayoutManager=function(d){this.changedTextAtRow=new k;this.invalidatedRects=new k;this.fontDimension=f;if(d.textStorage){d._textStorage=d.textStorage;delete d.textStorage}else this._textStorage=new e;o.mixin(this,d);this._textStorage.changed.add(this.textStorageChanged.bind(this));this.textLines=[{characters:"",colors:[{start:0,end:0,color:"plain"}]}];this.syntaxManager=d=new h(this);
d.attrsChanged.add(this._attrsChanged.bind(this));this._size={width:0,height:0};this.sizeChanged=new k;this._height=0;this._recomputeEntireLayout()};m.LayoutManager.prototype={_maximumWidth:0,_textStorage:null,_size:null,sizeChanged:null,_theme:{},margin:{left:5,bottom:6,top:0,right:12},pluginCatalog:a,syntaxManager:null,textLines:null,_attrsChanged:function(d,g){this.updateTextRows(d,g);this.invalidatedRects(this,this.rectsForRange({start:{row:d,col:0},end:{row:g,col:0}}))},_computeInvalidRects:function(d,
g){var j=this.characterRectForPosition(d.start),n={x:j.x,y:j.y,width:Number.MAX_VALUE,height:j.height};return d.end.row===g.end.row?[n]:[n,{x:0,y:j.y+f.lineHeight,width:Number.MAX_VALUE,height:Number.MAX_VALUE}]},_lastCharacterPosition:function(){return{row:this.textLines.length-1,col:this._maximumWidth}},_recalculateMaximumWidth:function(){var d=0;this.textLines.forEach(function(g){g=g.characters.length;if(d<g)d=g});this._maximumWidth=d;this.size={width:d,height:this.textLines.length}},_recomputeEntireLayout:function(){var d=
this._textStorage.range;this._recomputeLayoutForRanges(d,d)},_recomputeLayoutForRanges:function(d,g){for(var j=d.start.row,n=d.end.row,r=g.end.row,s=r-j+1,w=this._textStorage.lines,v=this._theme.plain,x=[],l=0;l<s;l++)x[l]={characters:w[j+l],colors:[{start:0,end:null,color:v}]};this.textLines=o.replace(this.textLines,j,n-j+1,x);this._recalculateMaximumWidth();n=this.textLines.length;s=this.syntaxManager;if(this._height!==n)this._height=n;s.invalidateRow(j);this.updateTextRows(j,r+1);this.changedTextAtRow(this,
j);this.invalidatedRects(this,this._computeInvalidRects(d,g))},boundingRect:function(){return this.rectsForRange({start:{row:0,col:0},end:{row:this.textLines.length-1,col:this._maximumWidth}})[0]},characterAtPoint:function(d){var g=this.margin,j=d.x-g.left,n=f.characterWidth,r=this._textStorage;d=r.clampPosition({row:Math.floor((d.y-g.top)/f.lineHeight),col:Math.floor(j/n)});r=r.lines[d.row].length;d.partialFraction=j<0||d.col===r?0:j%n/n;return d},characterRangeForBoundingRect:function(d){var g=
f.lineHeight,j=f.characterWidth,n=this.margin,r=d.x-n.left;n=d.y-n.top;return{start:{row:Math.max(Math.floor(n/g),0),col:Math.max(Math.floor(r/j),0)},end:{row:Math.floor((n+d.height-1)/g),col:Math.floor((r+d.width-1)/j)+1}}},characterRectForPosition:function(d){return this.rectsForRange({start:d,end:{row:d.row,col:d.col+1}})[0]},lineRectForRow:function(d){return this.rectsForRange({start:{row:d,col:0},end:{row:d,col:this._maximumWidth}})[0]},rectForPosition:function(d){var g=this.margin,j=f.characterWidth,
n=f.lineHeight;return{x:g.left+j*d.col,y:g.top+n*d.row,width:j,height:n}},rectsForRange:function(d){var g=f.characterWidth,j=f.lineHeight,n=this._maximumWidth,r=this.margin,s=d.start,w=d.end;d=s.row;var v=s.col;s=w.row;w=w.col;if(d===s)return[{x:r.left+g*v,y:r.top+j*d,width:g*(w-v),height:j}];var x=[],l;if(v===0)l=d;else{l=d+1;x.push({x:r.left+g*v,y:r.top+j*d,width:99999,height:j})}if(w===0)n=s-1;else if(w===n)n=s;else{n=s-1;x.push({x:r.left,y:r.top+j*s,width:g*w,height:j})}x.push({x:r.left,y:r.top+
j*l,width:99999,height:j*(n-l+1)});return x},textStorageChanged:function(d,g){this._recomputeLayoutForRanges(d,g)},updateTextRows:function(d,g){var j=this.textLines;g=this.syntaxManager.getAttrsForRows(d,g);for(var n=0;n<g.length;n++)j[d+n].colors=g[n]}};Object.defineProperties(m.LayoutManager.prototype,{size:{set:function(d){if(d.width!==this._size.width||d.height!==this._size.height){this.sizeChanged(d);this._size=d}},get:function(){return this._size}},textStorage:{get:function(){return this._textStorage}}})});
bespin.tiki.module("text_editor:controllers/search",function(q,m){var o=q("bespin:util/util");q("rangeutils:utils/range");q("bespin:console");m.EditorSearchController=function(k){this.editor=k};m.EditorSearchController.prototype={editor:null,_escapeString:/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g,_findMatchesInString:function(k){var h=[],e=this.searchRegExp,a;for(e.lastIndex=0;;){a=e.exec(k);if(a===null)break;h.push(a);e.lastIndex=a.index+a[0].length}return h},_makeRange:function(k,h){return{start:{row:h,
col:k.index},end:{row:h,col:k.index+k[0].length}}},isRegExp:null,searchRegExp:null,searchText:null,setSearchText:function(k,h){this.searchRegExp=h?new RegExp(k):new RegExp(k.replace(this._escapeString,"\\$1"),"gi");this.isRegExp=h;this.searchText=k},findNext:function(k,h){var e=this.searchRegExp;if(o.none(e))return null;k=k||this.editor.textView.getSelectedRange().end;var a=this.editor.layoutManager.textStorage.lines,b;e.lastIndex=k.col;var i;for(i=k.row;i<a.length;i++){b=e.exec(a[i]);if(!o.none(b))return this._makeRange(b,
i)}if(!h)return null;for(i=0;i<=k.row;i++){b=e.exec(a[i]);if(!o.none(b))return this._makeRange(b,i)}return null},findPrevious:function(k,h){if(o.none(this.searchRegExp))return null;k=k||this.editor.textView.getSelectedRange().start;var e=this.editor.buffer.layoutManager.textStorage.lines,a;a=this._findMatchesInString(e[k.row].substring(0,k.col));if(a.length!==0)return this._makeRange(a[a.length-1],k.row);var b;for(b=k.row-1;b!==-1;b--){a=this._findMatchesInString(e[b]);if(a.length!==0)return this._makeRange(a[a.length-
1],b)}if(!h)return null;for(b=e.length-1;b>=k.row;b--){a=this._findMatchesInString(e[b]);if(a.length!==0)return this._makeRange(a[a.length-1],b)}return null}}});
bespin.tiki.module("text_editor:controllers/undo",function(q,m){var o=q("bespin:console").console,k=q("environment").env;m.EditorUndoController=function(h){this.editor=h;h=this.textView=h.textView;h.beganChangeGroup.add(function(e,a){this._beginTransaction();this._record.selectionBefore=a}.bind(this));h.endedChangeGroup.add(function(e,a){this._record.selectionAfter=a;this._endTransaction()}.bind(this));h.replacedCharacters.add(function(e,a,b){if(!this._inTransaction)throw new Error("UndoController.textViewReplacedCharacters() called outside a transaction");
this._record.patches.push({oldCharacters:this._deletedCharacters,oldRange:a,newCharacters:b,newRange:this.editor.layoutManager.textStorage.resultingRangeForReplacement(a,b.split("\n"))});this._deletedCharacters=null}.bind(this));h.willReplaceRange.add(function(e,a){if(!this._inTransaction)throw new Error("UndoController.textViewWillReplaceRange() called outside a transaction");this._deletedCharacters=this.editor.layoutManager.textStorage.getCharacters(a)}.bind(this))};m.EditorUndoController.prototype=
{_inTransaction:false,_record:null,textView:null,_beginTransaction:function(){if(this._inTransaction){o.trace();throw new Error("UndoController._beginTransaction() called with a transaction already in place");}this._inTransaction=true;this._record={patches:[]}},_endTransaction:function(){if(!this._inTransaction)throw new Error("UndoController._endTransaction() called without a transaction in place");this.editor.buffer.undoManager.registerUndo(this,this._record);this._record=null;this._inTransaction=
false},_tryApplyingPatches:function(h){var e=this.editor.layoutManager.textStorage;h.forEach(function(a){e.replaceCharacters(a.oldRange,a.newCharacters)});return true},_undoOrRedo:function(h,e){if(this._inTransaction)throw new Error("UndoController._undoOrRedo() called while in a transaction");if(!this._tryApplyingPatches(h))return false;this.textView.setSelection(e,true);return true},redo:function(h){var e=h.patches.concat();e.reverse();return this._undoOrRedo(e,h.selectionAfter)},undo:function(h){return this._undoOrRedo(h.patches.map(function(e){return{oldCharacters:e.newCharacters,
oldRange:e.newRange,newCharacters:e.oldCharacters,newRange:e.oldRange}}),h.selectionBefore)}};m.undoManagerCommand=function(h,e){k.editor.buffer.undoManager[e.commandExt.name]()}});
bespin.tiki.module("text_editor:models/buffer",function(q,m){var o=q("environment").env,k=q("bespin:util/util"),h=q("bespin:promise").Promise,e=q("models/textstorage").TextStorage,a=q("controllers/layoutmanager").LayoutManager,b=q("undomanager").UndoManager;m.Buffer=function(i,f){this._file=i;this._model=new e(f);this._layoutManager=new a({textStorage:this._model});this.undoManager=new b;if(i)this.reload().then(function(){this._updateSyntaxManagerInitialContext()}.bind(this));else{this.loadPromise=
new h;this.loadPromise.resolve()}f=o.session?o.session.history:null;var d,g,j;if(f&&i&&(d=f.getHistoryForPath(i.path))){g=d.selection;j=d.scroll}this._selectedRange=g||{start:{row:0,col:0},end:{row:0,col:0}};this._scrollOffset=j||{x:0,y:0}};m.Buffer.prototype={undoManager:null,loadPromise:null,_scrollOffset:null,_selectedRange:null,_selectedRangeEndVirtual:null,_layoutManager:null,_file:null,_model:null,save:function(){return this._file.saveContents(this._model.value)},saveAs:function(i){var f=new h;
i.saveContents(this._model.value).then(function(){this._file=i;this._updateSyntaxManagerInitialContext();f.resolve()}.bind(this),function(d){f.reject(d)});return f},reload:function(){var i=this,f;return this.loadPromise=f=this._file.loadContents().then(function(d){i._model.value=d})},_updateSyntaxManagerInitialContext:function(){var i=this._file.extension();this._layoutManager.syntaxManager.setSyntaxFromFileExt(i===null?"":i)},untitled:function(){return k.none(this._file)}};Object.defineProperties(m.Buffer.prototype,
{layoutManager:{get:function(){return this._layoutManager}},syntaxManager:{get:function(){}},file:{get:function(){return this._file}},model:{get:function(){return this._model}}})});
bespin.tiki.module("text_editor:models/textstorage",function(q,m){var o=q("events").Event,k=q("bespin:util/util");q=function(h){this._lines=h!==null&&h!==undefined?h.split("\n"):[""];this.changed=new o;return this};q.prototype={_lines:null,readOnly:false,clampPosition:function(h){var e=this._lines,a=h.row;if(a<0)return{row:0,col:0};else if(a>=e.length)return this.range.end;h=Math.max(0,Math.min(h.col,e[a].length));return{row:a,col:h}},clampRange:function(h){var e=this.clampPosition(h.start);h=this.clampPosition(h.end);
return{start:e,end:h}},deleteCharacters:function(h){this.replaceCharacters(h,"")},displacePosition:function(h,e){var a=e>0,b=this._lines,i=b.length;for(e=Math.abs(e);e!==0;e--)if(a){var f=b[h.row].length;if(h.row===i-1&&h.col===f)return h;h=h.col===f?{row:h.row+1,col:0}:{row:h.row,col:h.col+1}}else{if(h.row===0&&h.col==0)return h;if(h.col===0){b=this._lines;h={row:h.row-1,col:b[h.row-1].length}}else h={row:h.row,col:h.col-1}}return h},getCharacters:function(h){var e=this._lines,a=h.start,b=h.end,
i=a.row;h=b.row;var f=a.col;a=b.col;if(i===h)return e[i].substring(f,a);b=e[i].substring(f);i=e.slice(i+1,h);e=e[h].substring(0,a);return[b].concat(i,e).join("\n")},getLines:function(){return this._lines},getRange:function(){var h=this._lines,e=h.length-1;return{start:{row:0,col:0},end:{row:e,col:h[e].length}}},getValue:function(){return this._lines.join("\n")},insertCharacters:function(h,e){this.replaceCharacters({start:h,end:h},e)},replaceCharacters:function(h,e){if(this.readOnly)throw new Error("Attempt to modify a read-only text storage object");
var a=e.split("\n"),b=a.length,i=this.resultingRangeForReplacement(h,a),f=h.start,d=h.end,g=f.row,j=d.row,n=this._lines;a[0]=n[g].substring(0,f.col)+a[0];a[b-1]+=n[j].substring(d.col);this._lines=k.replace(n,g,j-g+1,a);this.changed(h,i,e)},resultingRangeForReplacement:function(h,e){var a=e.length;h=h.start;return{start:h,end:{row:h.row+a-1,col:(a===1?h.col:0)+e[a-1].length}}},setLines:function(h){this.setValue(h.join("\n"))},setValue:function(h){this.replaceCharacters(this.range,h)}};m.TextStorage=
q;Object.defineProperties(m.TextStorage.prototype,{lines:{get:function(){return this.getLines()},set:function(h){return this.setLines(h)}},range:{get:function(){return this.getRange()}},value:{get:function(){return this.getValue()},set:function(h){this.setValue(h)}}})});
bespin.tiki.module("text_editor:utils/rect",function(q,m){m._distanceFromBounds=function(o,k,h){if(o<k)return o-k;if(o>=h)return o-h;return 0};m.merge=function(o){var k;do{k=false;for(var h=[],e=0;e<o.length;e++){var a=o[e];h.push(a);for(var b=e+1;b<o.length;b++){var i=o[b];if(m.rectsSideBySide(a,i)||m.rectsIntersect(a,i)){o.splice(b,1);h[h.length-1]=m.unionRects(a,i);k=true;break}}}o=h}while(k);return o};m.offsetFromRect=function(o,k){return{x:m._distanceFromBounds(k.x,o.x,m.maxX(o)),y:m._distanceFromBounds(k.y,
o.y,m.maxY(o))}};m.rectsIntersect=function(o,k){o=m.intersectRects(o,k);return o.width!==0&&o.height!==0};m.rectsSideBySide=function(o,k){if(o.x==k.x&&o.width==k.width)return o.y<k.y?o.y+o.height==k.y:k.y+k.height==o.y;else if(o.y==k.y&&o.height==k.height)return o.x<k.x?o.x+o.width==k.x:k.x+k.width==o.x;return false};m.intersectRects=function(o,k){o={x:Math.max(m.minX(o),m.minX(k)),y:Math.max(m.minY(o),m.minY(k)),width:Math.min(m.maxX(o),m.maxX(k)),height:Math.min(m.maxY(o),m.maxY(k))};o.width=Math.max(0,
o.width-o.x);o.height=Math.max(0,o.height-o.y);return o};m.minX=function(o){return o.x||0};m.maxX=function(o){return(o.x||0)+(o.width||0)};m.minY=function(o){return o.y||0};m.maxY=function(o){return(o.y||0)+(o.height||0)};m.pointInRect=function(o,k){return o.x>=m.minX(k)&&o.y>=m.minY(k)&&o.x<=m.maxX(k)&&o.y<=m.maxY(k)};m.unionRects=function(o,k){o={x:Math.min(m.minX(o),m.minX(k)),y:Math.min(m.minY(o),m.minY(k)),width:Math.max(m.maxX(o),m.maxX(k)),height:Math.max(m.maxY(o),m.maxY(k))};o.width=Math.max(0,
o.width-o.x);o.height=Math.max(0,o.height-o.y);return o};m.rectsEqual=function(o,k,h){if(!o||!k)return o==k;if(!h&&h!==0)h=0.1;if(o.y!=k.y&&Math.abs(o.y-k.y)>h)return false;if(o.x!=k.x&&Math.abs(o.x-k.x)>h)return false;if(o.width!=k.width&&Math.abs(o.width-k.width)>h)return false;if(o.height!=k.height&&Math.abs(o.height-k.height)>h)return false;return true}});
bespin.tiki.module("text_editor:views/canvas",function(q,m){var o=q("bespin:util/util"),k=q("utils/rect"),h=q("events").Event;m.CanvasView=function(e,a,b){if(e){this._preventDownsize=a||false;this._clearOnFullInvalid=b||false;this._clippingFrame=this._frame={x:0,y:0,width:0,height:0};this._invalidRects=[];a=document.createElement("canvas");a.setAttribute("style","position: absolute");a.innerHTML="canvas tag not supported by your browser";e.appendChild(a);this.domNode=a;this.clippingChanged=new h;
this.clippingChanged.add(this.clippingFrameChanged.bind(this))}};m.CanvasView.prototype={domNode:null,clippingChanged:null,_canvasContext:null,_canvasId:null,_invalidRects:null,_lastRedrawTime:null,_redrawTimer:null,_clippingFrame:null,_preventDownsize:false,_clearOnFullInvalid:false,_frame:null,_getContext:function(){if(this._canvasContext===null)this._canvasContext=this.domNode.getContext("2d");return this._canvasContext},computeWithClippingFrame:function(e,a){var b=this.clippingFrame;return{x:e+
b.x,y:a+b.y}},minimumRedrawDelay:1E3/30,clippingFrameChanged:function(){this.invalidate()},drawRect:function(){},render:function(){if(!(this._renderTimer||this._redrawTimer))this._renderTimer=setTimeout(this._tryRedraw.bind(this),0)},invalidate:function(){this._invalidRects="all";this.render()},invalidateRect:function(e){var a=this._invalidRects;if(a!=="all"){a.push(e);this.render()}},_tryRedraw:function(){this._renderTimer=null;var e=(new Date).getTime(),a=this._lastRedrawTime,b=this.minimumRedrawDelay;
if(a===null||e-a>=b)this._redraw();else if(this._redrawTimer===null)this._redrawTimer=window.setTimeout(this._redraw.bind(this),b)},_redraw:function(){var e=this.clippingFrame;e={x:Math.round(e.x),y:Math.round(e.y),width:e.width,height:e.height};var a=this._getContext();a.save();a.translate(-e.x,-e.y);var b=this._invalidRects;if(b==="all"){this._clearOnFullInvalid&&a.clearRect(0,0,this.domNode.width,this.domNode.height);this.drawRect(e,a)}else k.merge(b).forEach(function(i){i=k.intersectRects(i,e);
if(i.width!==0&&i.height!==0){a.save();var f=i.x,d=i.y,g=i.width,j=i.height;a.beginPath();a.moveTo(f,d);a.lineTo(f+g,d);a.lineTo(f+g,d+j);a.lineTo(f,d+j);a.closePath();a.clip();this.drawRect(i,a);a.restore()}},this);a.restore();this._invalidRects=[];this._redrawTimer=null;this._lastRedrawTime=(new Date).getTime()}};Object.defineProperties(m.CanvasView.prototype,{clippingFrame:{get:function(){return this._clippingFrame},set:function(e){e=o.mixin(o.clone(this._clippingFrame),e);if(this._clippingFrame===
null||!k.rectsEqual(e,this._clippingFrame)){this._clippingFrame=e;this.clippingChanged()}}},frame:{get:function(){return this._frame},set:function(e){var a=this.domNode,b=a.style,i=this._preventDownsize,f=a.width,d=a.height;b=a.style;b.left=e.x+"px";b.top=e.y+"px";var g,j;if(e.width!==f)if(e.width<f)i||(g=true);else g=true;if(e.height!==d)if(e.height<d)i||(j=true);else j=true;if(g)this.domNode.width=e.width;if(j)this.domNode.height=e.height;this._frame=e;this.clippingFrame={width:e.width,height:e.height}}}})});
bespin.tiki.module("text_editor:views/editor",function(q,m){function o(l){var p=s.plugins.text_editor.provides,t=p.length,u={};if(l){l=l.themestyles;if(l.currentThemeVariables&&l.currentThemeVariables.text_editor)u=l.currentThemeVariables.text_editor}for(;t--;)if(p[t].ep==="themevariable"){l=e.mixin(e.clone(p[t].defaultValue),u[p[t].name]);switch(p[t].name){case "gutter":case "editor":case "scroller":case "highlighter":x[p[t].name]=l}}}var k=q("rangeutils:utils/range"),h=q("views/scroller"),e=q("bespin:util/util"),
a=q("models/buffer").Buffer,b=q("completion:controller").CompletionController,i=q("controllers/search").EditorSearchController,f=q("controllers/undo").EditorUndoController,d=q("events").Event,g=q("views/gutter").GutterView;q("controllers/layoutmanager");var j=h.ScrollerCanvasView,n=q("views/text").TextView,r=q("underscore")._,s=q("bespin:plugins").catalog,w=q("keyboard:keyboard").keyboardManager,v=q("settings").settings,x={};o();s.registerExtension("themeChange",{pointer:o});m.EditorView=function(l){this.elementAppended=
new d;var p=this.element=this.container=document.createElement("div");p.style.overflow="visible";p.style.position="relative";this.scrollOffsetChanged=new d;this.willChangeBuffer=new d;this.selectionChanged=new d;this.textChanged=new d;this.gutterView=new g(p,this);this.textView=new n(p,this);var t=new j(this,h.LAYOUT_VERTICAL),u=new j(this,h.LAYOUT_HORIZONTAL);this.verticalScroller=t;this.horizontalScroller=u;this.completionController=new b(this);this.editorUndoController=new f(this);this.searchController=
new i(this);this._textViewSize=this._oldSize={width:0,height:0};this._themeData=x;this.buffer=new a(null,l);this.elementAppended.add(function(){var A=v.get("fontsize"),E=v.get("fontface");this._font=A+"px "+E;s.registerExtension("themeChange",{pointer:this._themeVariableChange.bind(this)});s.registerExtension("settingChange",{match:"font[size|face]",pointer:this._fontSettingChanged.bind(this)});s.registerExtension("dimensionsChanged",{pointer:this.dimensionsChanged.bind(this)});this._dontRecomputeLayout=
false;this._recomputeLayout();p.addEventListener(e.isMozilla?"DOMMouseScroll":"mousewheel",this._onMouseWheel.bind(this),false);t.valueChanged.add(function(B){this.scrollOffset={y:B}}.bind(this));u.valueChanged.add(function(B){this.scrollOffset={x:B}}.bind(this));this.scrollOffsetChanged.add(function(B){this._updateScrollOffsetChanged(B)}.bind(this))}.bind(this))};m.EditorView.prototype={elementAppended:null,textChanged:null,selectionChanged:null,scrollOffsetChanged:null,willChangeBuffer:null,_textViewSize:null,
_textLinesCount:0,_gutterViewWidth:0,_oldSize:null,_buffer:null,_dontRecomputeLayout:true,_themeData:null,_layoutManagerSizeChanged:function(l){var p=this.layoutManager.fontDimension;this._textViewSize={width:l.width*p.characterWidth,height:l.height*p.lineHeight};if(this._textLinesCount!==l.height){this.gutterView.computeWidth()!==this._gutterViewWidth?this._recomputeLayout(true):this.gutterView.invalidate();this._textLinesLength=l.height}this._updateScrollers();this.scrollOffset={}},_updateScrollers:function(){if(!this._dontRecomputeLayout){var l=
this.textViewPaddingFrame,p=this._textViewSize.width,t=this._textViewSize.height,u=this.scrollOffset,A=this.verticalScroller,E=this.horizontalScroller;if(t<l.height)A.isVisible=false;else{A.isVisible=true;A.proportion=l.height/t;A.maximum=t-l.height;A.value=u.y}if(p<l.width)E.isVisible=false;else{E.isVisible=true;E.proportion=l.width/p;E.maximum=p-l.width;E.value=u.x}}},_onMouseWheel:function(l){var p=0;if(l.wheelDelta)p=-l.wheelDelta;else if(l.detail)p=l.detail*40;var t=true;if(l.axis){if(l.axis==
l.HORIZONTAL_AXIS)t=false}else if(l.wheelDeltaY||l.wheelDeltaX){if(l.wheelDeltaX==l.wheelDelta)t=false}else if(l.shiftKey)t=false;t?this.scrollBy(0,p):this.scrollBy(p*5,0);e.stopEvent(l)},scrollTo:function(l){this.scrollOffset=l},scrollBy:function(l,p){this.scrollOffset={x:this.scrollOffset.x+l,y:this.scrollOffset.y+p}},_recomputeLayout:function(l){if(!this._dontRecomputeLayout){var p=this.container.offsetWidth,t=this.container.offsetHeight;if(!(!l&&p==this._oldSize.width&&t==this._oldSize.height)){this._oldSize=
{width:p,height:t};this._gutterViewWidth=l=this.gutterView.computeWidth();this.gutterView.frame={x:0,y:0,width:l,height:t};this.textView.frame={x:l,y:0,width:p-l,height:t};var u=this._themeData.scroller.padding,A=this._themeData.scroller.thickness;this.horizontalScroller.frame={x:l+u,y:t-(A+u),width:p-(l+2*u+A),height:A};this.verticalScroller.frame={x:p-(u+A),y:u,width:A,height:t-(2*u+A)};this.scrollOffset={};this._updateScrollers();this.gutterView.invalidate();this.textView.invalidate();this.verticalScroller.invalidate();
this.horizontalScroller.invalidate()}}},dimensionsChanged:function(){this._recomputeLayout()},_font:null,_fontSettingChanged:function(){var l=v.get("fontsize"),p=v.get("fontface");this._font=l+"px "+p;this.layoutManager._recalculateMaximumWidth();this._layoutManagerSizeChanged(this.layoutManager.size);this.textView.invalidate()},_themeVariableChange:function(){this._recomputeLayout(true)},_updateScrollOffsetChanged:function(l){this.verticalScroller.value=l.y;this.horizontalScroller.value=l.x;this.textView.clippingFrame=
{x:l.x,y:l.y};this.gutterView.clippingFrame={y:l.y};this._updateScrollers();this.gutterView.invalidate();this.textView.invalidate()},processKeyEvent:function(l,p,t){t=r(t).clone();t.completing=this.completionController.isCompleting();return w.processKeyEvent(l,p,t)},convertTextViewPoint:function(l){var p=this.scrollOffset;return{x:l.x-p.x+this._gutterViewWidth,y:l.y-p.y}},replace:function(l,p,t){if(!k.isRange(l))throw new Error('replace(): expected range but found "'+l+"'");if(!e.isString(p))throw new Error('replace(): expected text string but found "'+
text+'"');var u=k.normalizeRange(l),A=this.textView,E=A.getSelectedRange(false);return A.groupChanges(function(){A.replaceCharacters(u,p);if(t)A.setSelection(E);else{var B=p.split("\n");B=B.length>1?{row:l.start.row+B.length-1,col:B[B.length-1].length}:k.addPositions(l.start,{row:0,col:p.length});A.moveCursorTo(B)}})},getText:function(l){if(!k.isRange(l))throw new Error('getText(): expected range but found "'+l+'"');return this.layoutManager.textStorage.getCharacters(k.normalizeRange(l))},setLineNumber:function(l){if(!e.isNumber(l))throw new Error("setLineNumber(): lineNumber must be a number");
this.textView.moveCursorTo({row:l-1,col:0})},setCursor:function(l){if(!k.isPosition(l))throw new Error('setCursor(): expected position but found "'+l+'"');this.textView.moveCursorTo(l)},changeGroup:function(l){return this.textView.groupChanges(function(){l(this)}.bind(this))},addTags:function(l){this.completionController.tags.add(l)}};Object.defineProperties(m.EditorView.prototype,{themeData:{get:function(){return this._themeData},set:function(){throw new Error("themeData can't be changed directly. Use themeManager.");
}},font:{get:function(){return this._font},set:function(){throw new Error("font can't be changed directly. Use settings fontsize and fontface.");}},buffer:{set:function(l){if(l!==this._buffer){if(!l.loadPromise.isResolved())throw new Error("buffer.set(): the new buffer must first be loaded!");if(this._buffer!==null){this.layoutManager.sizeChanged.remove(this);this.layoutManager.textStorage.changed.remove(this);this.textView.selectionChanged.remove(this)}this.willChangeBuffer(l);s.publish(this,"editorChange",
"buffer",l);this.layoutManager=l.layoutManager;this._buffer=l;var p=this.layoutManager,t=this.textView;p.sizeChanged.add(this,this._layoutManagerSizeChanged.bind(this));p.textStorage.changed.add(this,this.textChanged.bind(this));t.selectionChanged.add(this,this.selectionChanged.bind(this));this.textView.setSelection(l._selectedRange,false);this.scrollOffsetChanged(l._scrollOffset);this.layoutManager.sizeChanged(this.layoutManager.size);this._recomputeLayout()}},get:function(){return this._buffer}},
frame:{get:function(){return{width:this.container.offsetWidth,height:this.container.offsetHeight}}},textViewPaddingFrame:{get:function(){var l=e.clone(this.textView.frame),p=this.textView.padding;l.width-=p.left+p.right;l.height-=p.top+p.bottom;return l}},scrollOffset:{set:function(l){if(l.x===undefined)l.x=this.scrollOffset.x;if(l.y===undefined)l.y=this.scrollOffset.y;var p=this.textViewPaddingFrame;if(l.y<0)l.y=0;else if(this._textViewSize.height<p.height)l.y=0;else if(l.y+p.height>this._textViewSize.height)l.y=
this._textViewSize.height-p.height;if(l.x<0)l.x=0;else if(this._textViewSize.width<p.width)l.x=0;else if(l.x+p.width>this._textViewSize.width)l.x=this._textViewSize.width-p.width;if(!(l.x===this.scrollOffset.x&&l.y===this.scrollOffset.y)){this.buffer._scrollOffset=l;this.scrollOffsetChanged(l);s.publish(this,"editorChange","scrollOffset",l)}},get:function(){return this.buffer._scrollOffset}},readOnly:{get:function(){return this._buffer.model.readOnly},set:function(l){this._buffer.model.readOnly=l}},
focus:{get:function(){return this.textView.hasFocus},set:function(l){if(!e.isBoolean(l))throw new Error('set focus: expected boolean but found "'+l+'"');this.textView.hasFocus=l}},selection:{get:function(){return e.clone(this.textView.getSelectedRange(false))},set:function(l){if(!k.isRange(l))throw new Error("set selection: position/selection must be supplied");this.textView.setSelection(l)}},selectedText:{get:function(){return this.getText(this.selection)},set:function(l){if(!e.isString(l))throw new Error('set selectedText: expected string but found "'+
l+'"');return this.replace(this.selection,l)}},value:{get:function(){return this.layoutManager.textStorage.value},set:function(l){if(!e.isString(l))throw new Error('set value: expected string but found "'+l+'"');return this.replace(this.layoutManager.textStorage.range,l,false)}},syntax:{get:function(){return this.layoutManager.syntaxManager.getSyntax()},set:function(l){if(!e.isString(l))throw new Error('set syntax: expected string but found "'+newValue+'"');return this.layoutManager.syntaxManager.setSyntax(l)}}})});
bespin.tiki.module("text_editor:views/gutter",function(q,m){var o=q("bespin:util/util"),k=q("views/canvas").CanvasView;m.GutterView=function(h,e){k.call(this,h,true);this.editor=e};m.GutterView.prototype=new k;o.mixin(m.GutterView.prototype,{drawRect:function(h,e){var a=this.editor.themeData.gutter;e.fillStyle=a.backgroundColor;e.fillRect(h.x,h.y,h.width,h.height);e.save();e.translate(a.paddingLeft,0);var b=this.editor.layoutManager,i=b.characterRangeForBoundingRect(h);h=Math.min(i.end.row,b.textLines.length-
1);var f=b.fontDimension.lineAscent;e.fillStyle=a.color;e.font=this.editor.font;for(a=i.start.row;a<=h;a++)e.fillText(""+(a+1),-0.5,b.lineRectForRow(a).y+f-0.5);e.restore()},computeWidth:function(){var h=this.editor.themeData.gutter,e=this.editor.layoutManager;return e.fontDimension.characterWidth*(""+e.textLines.length).length+(h.paddingLeft+h.paddingRight)}})});
bespin.tiki.module("text_editor:views/scroller",function(q,m){var o=q("bespin:util/util"),k=q("events").Event,h=q("bespin:console").console,e=q("utils/rect"),a=q("views/canvas").CanvasView,b=m.LAYOUT_HORIZONTAL=0,i=m.LAYOUT_VERTICAL=1;m.ScrollerCanvasView=function(f,d){a.call(this,f.container,false,true);this.editor=f;this.layoutDirection=d;f=function(g,j,n){n=n||this.domNode;n.addEventListener(g,function(r){j.call(this,r);o.stopEvent(r)}.bind(this),false)}.bind(this);f("mouseover",this.mouseEntered);
f("mouseout",this.mouseExited);f("mousedown",this.mouseDown);f("mouseup",this.mouseUp,window);f("mousemove",this.mouseMove,window);this.valueChanged=new k};m.ScrollerCanvasView.prototype=new a;o.mixin(m.ScrollerCanvasView.prototype,{lineHeight:20,proportion:0,layoutDirection:i,_isVisible:false,_maximum:0,_value:0,valueChanged:null,padding:{left:0,bottom:0,top:0,right:0},_mouseDownScreenPoint:null,_mouseDownValue:null,_isMouseOver:false,_scrollTimer:null,_mouseEventPosition:null,_mouseOverHandle:false,
_drawNib:function(f){var d=this.editor.themeData.scroller,g,j;g=d.nibStyle;j=d.nibArrowStyle;d=d.nibStrokeStyle;var n=Math.floor(7.5);f.fillStyle=g;f.beginPath();f.arc(0,0,Math.floor(7.5),0,Math.PI*2,true);f.closePath();f.fill();f.strokeStyle=d;f.stroke();f.fillStyle=j;f.beginPath();f.moveTo(0,-n+3);f.lineTo(-n+3,n-5);f.lineTo(n-3,n-5);f.closePath();f.fill()},_drawNibs:function(f,d){var g=this._getClientThickness(),j=this._value,n=this._maximum,r=this._isHighlighted();if(r||j!==0){f.save();f.translate(8,
g/2);f.rotate(Math.PI*1.5);f.moveTo(0,0);this._drawNib(f,d);f.restore()}if(r||j!==n){f.save();f.translate(this._getClientLength()-8,g/2);f.rotate(Math.PI*0.5);f.moveTo(0,0);this._drawNib(f,d);f.restore()}},_getClientFrame:function(){var f=this.frame,d=this.padding;return{x:d.left,y:d.top,width:f.width-(d.left+d.right),height:f.height-(d.top+d.bottom)}},_getClientLength:function(){var f=this._getClientFrame();switch(this.layoutDirection){case b:return f.width;case i:return f.height;default:h.error("unknown layout direction");
return null}},_getClientThickness:function(){var f=this.padding,d=this.editor.themeData.scroller.thickness;switch(this.layoutDirection){case i:return d-(f.left+f.right);case b:return d-(f.top+f.bottom);default:h.error("unknown layout direction");return null}},_getFrameLength:function(){switch(this.layoutDirection){case b:return this.frame.width;case i:return this.frame.height;default:h.error("unknown layout direction");return null}},_getGutterFrame:function(){var f=this._getClientFrame(),d=this._getClientThickness();
switch(this.layoutDirection){case i:return{x:f.x,y:f.y+15,width:d,height:Math.max(0,f.height-30)};case b:return{x:f.x+15,y:f.y,width:Math.max(0,f.width-30),height:d};default:h.error("unknown layout direction");return null}},_getGutterLength:function(){var f=this._getGutterFrame(),d;switch(this.layoutDirection){case b:d=f.width;break;case i:d=f.height;break;default:h.error("unknown layout direction");break}return d},_getHandleFrame:function(){var f=this._getGutterFrame(),d=this._getHandleOffset(),
g=this._getHandleLength();switch(this.layoutDirection){case i:return{x:f.x,y:f.y+d,width:f.width,height:g};case b:return{x:f.x+d,y:f.y,width:g,height:f.height}}},_getHandleLength:function(){var f=this._getGutterLength();return Math.max(f*this.proportion,20)},_getHandleOffset:function(){var f=this._maximum;if(f===0)return 0;var d=this._getGutterLength(),g=this._getHandleLength();return(d-g)*this._value/f},_isHighlighted:function(){return this._isMouseOver===true||this._mouseDownScreenPoint!==null},
_segmentForMouseEvent:function(f){f={x:f.layerX,y:f.layerY};var d=this._getClientFrame(),g=this.padding;if(!e.pointInRect(f,d))return null;var j=this.layoutDirection;switch(j){case b:if(f.x-g.left<15)return"nib-start";else if(f.x>=d.width-15)return"nib-end";break;case i:if(f.y-g.top<15)return"nib-start";else if(f.y>=d.height-15)return"nib-end";break;default:h.error("unknown layout direction");break}g=this._getHandleFrame();if(e.pointInRect(f,g))return"handle";switch(j){case b:if(f.x<g.x)return"gutter-before";
else if(f.x>=g.x+g.width)return"gutter-after";break;case i:if(f.y<g.y)return"gutter-before";else if(f.y>=g.y+g.height)return"gutter-after";break;default:h.error("unknown layout direction");break}h.error("_segmentForMouseEvent: point ",f," outside view with handle frame ",g," and client frame ",d);return null},adjustFrame:function(){var f=this.frame;this.set("layout",{left:0,top:0,width:f.width,height:f.height})},drawRect:function(f,d){if(this._isVisible){var g=this._isHighlighted();f=this.editor.themeData.scroller;
var j=g?f.fullAlpha:f.particalAlpha,n=this.frame;d.clearRect(0,0,n.width,n.height);d.save();n=this.padding;d.translate(n.left,n.top);this._getHandleFrame();n=this._getGutterLength();var r=this._getClientThickness(),s=r/2,w=this.layoutDirection,v=this._getHandleOffset()+15,x=this._getHandleLength();if(w===i){d.translate(r+1,0);d.rotate(Math.PI*0.5)}if(!(n<=x)){d.globalAlpha=j;if(g){g=this._getClientLength();d.fillStyle=f.trackFillStyle;d.fillRect(8.5,0.5,g-16,r-1);d.strokeStyle=f.trackStrokeStyle;
d.strokeRect(8.5,0.5,g-16,r-1)}g=function(){d.beginPath();d.arc(v+s+0.5,s,s-0.5,Math.PI/2,3*Math.PI/2,false);d.arc(v+x-s-0.5,s,s-0.5,3*Math.PI/2,Math.PI/2,false);d.lineTo(v+s+0.5,r-0.5);d.closePath()};g();n=d.createLinearGradient(v,0,v,r);n.addColorStop(0,f.barFillGradientTopStart);n.addColorStop(0.4,f.barFillGradientTopStop);n.addColorStop(0.41,f.barFillStyle);n.addColorStop(0.8,f.barFillGradientBottomStart);n.addColorStop(1,f.barFillGradientBottomStop);d.fillStyle=n;d.fill();d.save();d.clip();d.fillStyle=
f.barFillStyle;d.beginPath();d.moveTo(v+s*0.4,s*0.6);d.lineTo(v+s*0.9,r*0.4);d.lineTo(v,r*0.4);d.closePath();d.fill();d.beginPath();d.moveTo(v+x-s*0.4,0+s*0.6);d.lineTo(v+x-s*0.9,0+r*0.4);d.lineTo(v+x,0+r*0.4);d.closePath();d.fill();d.restore();d.save();g();d.strokeStyle=f.trackStrokeStyle;d.stroke();d.restore();this._drawNibs(d,j);d.restore()}}},_repeatAction:function(f,d){if(f()!==false){var g=function(){this._repeatAction(f,100)}.bind(this);this._scrollTimer=setTimeout(g,d)}},_scrollByDelta:function(f){this.value=
this._value+f},_scrollUpOneLine:function(){this._scrollByDelta(-this.lineHeight);return true},_scrollDownOneLine:function(){this._scrollByDelta(this.lineHeight);return true},_scrollPage:function(){switch(this._segmentForMouseEvent(this._mouseEventPosition)){case "gutter-before":this._scrollByDelta(this._getGutterLength()*-1);break;case "gutter-after":this._scrollByDelta(this._getGutterLength());break;case null:break;default:return false}return true},mouseDown:function(f){this._mouseEventPosition=
f;this._mouseOverHandle=false;this._getGutterLength();switch(this._segmentForMouseEvent(f)){case "nib-start":this._repeatAction(this._scrollUpOneLine.bind(this),500);break;case "nib-end":this._repeatAction(this._scrollDownOneLine.bind(this),500);break;case "gutter-before":this._repeatAction(this._scrollPage.bind(this),500);break;case "gutter-after":this._repeatAction(this._scrollPage.bind(this),500);break;case "handle":break;default:h.error("_segmentForMouseEvent returned an unknown value");break}switch(this.layoutDirection){case b:this._mouseDownScreenPoint=
f.pageX;break;case i:this._mouseDownScreenPoint=f.pageY;break;default:h.error("unknown layout direction");break}},mouseMove:function(f){if(this._mouseDownScreenPoint!==null){if(this._segmentForMouseEvent(f)=="handle"||this._mouseOverHandle===true){this._mouseOverHandle=true;if(this._scrollTimer!==null){clearTimeout(this._scrollTimer);this._scrollTimer=null}var d;switch(this.layoutDirection){case b:d=f.pageX;break;case i:d=f.pageY;break;default:h.error("unknown layout direction");break}var g=d-this._mouseDownScreenPoint,
j=this._maximum,n=this._value,r=this._getGutterLength(),s=this._getHandleLength();this.value=n+j*g/(r-s);this._mouseDownScreenPoint=d}this._mouseEventPosition=f}},mouseEntered:function(){this._isMouseOver=true;this.invalidate()},mouseExited:function(){this._isMouseOver=false;this.invalidate()},mouseUp:function(){this._mouseDownValue=this._mouseDownScreenPoint=null;if(this._scrollTimer){clearTimeout(this._scrollTimer);this._scrollTimer=null}this.invalidate()}});Object.defineProperties(m.ScrollerCanvasView.prototype,
{isVisible:{set:function(f){if(this._isVisible!==f){this._isVisible=f;this.domNode.style.display=f?"block":"none";f&&this.invalidate()}}},maximum:{set:function(f){if(this._value>this._maximum)this._value=this._maximum;if(f!==this._maximum){this._maximum=f;this.invalidate()}}},value:{set:function(f){if(f<0)f=0;else if(f>this._maximum)f=this._maximum;if(f!==this._value){this._value=f;this.valueChanged(f);this.invalidate()}}}})});
bespin.tiki.module("text_editor:views/text",function(q,m){var o=q("bespin:plugins").catalog,k=q("bespin:util/util"),h=q("events").Event,e=q("views/canvas").CanvasView;q("controllers/layoutmanager");var a=q("rangeutils:utils/range"),b=q("utils/rect"),i=q("views/textinput").TextInput,f=q("bespin:console").console,d=q("settings").settings;m.TextView=function(g,j){e.call(this,g,true);this.editor=j;this.textInput=new i(g,this);this.padding={top:0,bottom:30,left:0,right:30};this.clippingChanged.add(this.clippingFrameChanged.bind(this));
g=this.domNode;g.style.cursor="text";g.addEventListener("mousedown",this.mouseDown.bind(this),false);g.addEventListener("mousemove",this.mouseMove.bind(this),false);window.addEventListener("mouseup",this.mouseUp.bind(this),false);j.willChangeBuffer.add(this.editorWillChangeBuffer.bind(this));this.selectionChanged=new h;this.beganChangeGroup=new h;this.endedChangeGroup=new h;this.willReplaceRange=new h;this.replacedCharacters=new h};m.TextView.prototype=new e;k.mixin(m.TextView.prototype,{_dragPoint:null,
_dragTimer:null,_enclosingScrollView:null,_inChangeGroup:false,_insertionPointBlinkTimer:null,_insertionPointVisible:true,_keyBuffer:"",_keyMetaBuffer:"",_keyState:"start",_hasFocus:false,_mouseIsDown:false,selectionChanged:null,beganChangeGroup:null,endedChangeGroup:null,willReplaceRange:null,replacedCharacters:null,editorWillChangeBuffer:function(g){if(this.editor.layoutManager){var j=this.editor.layoutManager;j.invalidatedRects.remove(this);j.changedTextAtRow.remove(this)}j=g.layoutManager;j.invalidatedRects.add(this,
this.layoutManagerInvalidatedRects.bind(this));j.changedTextAtRow.add(this,this.layoutManagerChangedTextAtRow.bind(this))},didFocus:function(){this._setFocus(true,true)},didBlur:function(){this._setFocus(false,true)},_drag:function(){var g=this._dragPoint,j=b.offsetFromRect(this.clippingFrame,g);this.moveCursorTo(this._selectionPositionForPoint({x:g.x-j.x,y:g.y-j.y}),true)},_drawInsertionPoint:function(g,j){if(this._insertionPointVisible){var n=this.editor.layoutManager.characterRectForPosition(this.editor.buffer._selectedRange.start);
g=Math.floor(n.x);var r=n.y,s=Math.ceil(n.width);n=n.height;j.save();var w=this.editor.themeData.editor;if(this._hasFocus){j.strokeStyle=w.cursorColor;j.beginPath();j.moveTo(g+0.5,r);j.lineTo(g+0.5,r+n);j.closePath();j.stroke()}else{j.fillStyle=w.unfocusedCursorBackgroundColor;j.fillRect(g+0.5,r,s-0.5,n);j.strokeStyle=w.unfocusedCursorColor;j.strokeRect(g+0.5,r+0.5,s-1,n-1)}j.restore()}},_drawLines:function(g,j){var n=this.editor.layoutManager,r=n.textLines,s=n.fontDimension.lineAscent,w=this.editor.themeData.highlighter;
j.save();j.font=this.editor.font;var v=n.characterRangeForBoundingRect(g),x=v.start;v=v.end;for(var l=v.row,p=x.row;p<=l;p++){var t=r[p];if(!k.none(t)){var u=t.characters,A=u.length,E=Math.min(v.col,A),B=x.col;if(!(B>=A)){t=t.colors;if(t==null)t=[];for(A=0;A<t.length&&B<t[A].start;)A++;for(var G=A<t.length?t[A].start:B;G<E;){g=t[A];B=g!=null?g.end:E;g=g!=null?g.tag:"plain";g=w.hasOwnProperty(g)?w[g]:"red";j.fillStyle=g;g=n.characterRectForPosition({row:p,col:G});G=u.substring(G,B);j.fillText(G,g.x,
g.y+s);G=B;A++}}}}j.restore()},_drawSelectionHighlight:function(g,j){g=this.editor.themeData.editor;g=this._hasFocus?g.selectedTextBackgroundColor:g.unfocusedCursorBackgroundColor;var n=this.editor.layoutManager;j.save();var r=a.normalizeRange(this.editor.buffer._selectedRange);j.fillStyle=g;n.rectsForRange(r).forEach(function(s){j.fillRect(s.x,s.y,s.width,s.height)});j.restore()},_drawSelection:function(g,j){this._rangeIsInsertionPoint(this.editor.buffer._selectedRange)?this._drawInsertionPoint(g,
j):this._drawSelectionHighlight(g,j)},_getVirtualSelection:function(g){var j=this.editor.buffer._selectedRange,n=this.editor.buffer._selectedRangeEndVirtual;return{start:g&&n?n:j.start,end:n||j.end}},_invalidateSelection:function(){var g=function(r){return{x:r.x-1,y:r.y,width:r.width+2,height:r.height}},j=this.editor.layoutManager,n=a.normalizeRange(this.editor.buffer._selectedRange);if(this._rangeIsInsertionPoint(n)){j=j.characterRectForPosition(n.start);this.invalidateRect(g(j))}else j.rectsForRange(n).forEach(function(r){this.invalidateRect(g(r))},
this)},_isReadOnly:function(){return this.editor.layoutManager.textStorage.readOnly},_keymappingChanged:function(){this._keyBuffer="";this._keyState="start"},_performVerticalKeyboardSelection:function(g){var j=this.editor.buffer._selectedRangeEndVirtual;this.moveCursorTo(a.addPositions(j!==null?j:this.editor.buffer._selectedRange.end,{row:g,col:0}),true,true)},_rangeIsInsertionPoint:function(g){return a.isZeroLength(g)},_rearmInsertionPointBlinkTimer:function(){this._insertionPointVisible||this.blinkInsertionPoint();
this._insertionPointBlinkTimer!==null&&clearInterval(this._insertionPointBlinkTimer);this._insertionPointBlinkTimer=setInterval(this.blinkInsertionPoint.bind(this),750)},_repositionSelection:function(){var g=this.editor.layoutManager.textLines,j=g.length,n=this.editor.buffer._selectedRange,r=Math.min(n.start.row,j-1);j=Math.min(n.end.row,j-1);var s=g[j];this.setSelection({start:{row:r,col:Math.min(n.start.col,g[r].characters.length)},end:{row:j,col:Math.min(n.end.col,s.characters.length)}})},_scrollPage:function(g){this.editor.scrollBy(0,
(this.clippingFrame.height+this.editor.layoutManager.fontDimension.lineAscent)*(g?-1:1))},_scrollWhileDragging:function(){var g=this._dragPoint;g=this.computeWithClippingFrame(g.layerX,g.layerY);k.mixin(this._dragPoint,g);this._drag()},_selectionPositionForPoint:function(g){g=this.editor.layoutManager.characterAtPoint(g);return g.partialFraction<0.5?g:a.addPositions(g,{row:0,col:1})},_syntaxManagerUpdatedSyntaxForRows:function(g,j){if(g!==j){var n=this.editor.layoutManager;n.updateTextRows(g,j);n.rectsForRange({start:{row:g,
col:0},end:{row:j,col:0}}).forEach(this.invalidateRect,this)}},blinkInsertionPoint:function(){this._insertionPointVisible=!this._insertionPointVisible;this._invalidateSelection()},copy:function(){return this.getSelectedCharacters()},cut:function(){var g=this.getSelectedCharacters();g!=""&&this.performBackspaceOrDelete(false);return g},drawRect:function(g,j){j.fillStyle=this.editor.themeData.editor.backgroundColor;j.fillRect(g.x,g.y,g.width,g.height);this._drawSelection(g,j);this._drawLines(g,j)},
focus:function(){this.textInput.focus()},getInsertionPointPosition:function(){var g=this.editor;g=g.layoutManager.characterRectForPosition(g.buffer._selectedRange.start);return{x:g.x,y:g.y}},getSelectedCharacters:function(){return this._rangeIsInsertionPoint(this.editor.buffer._selectedRange)?"":this.editor.layoutManager.textStorage.getCharacters(a.normalizeRange(this.editor.buffer._selectedRange))},getSelectedRange:function(g){return g?this.editor.buffer._selectedRange:a.normalizeRange(this.editor.buffer._selectedRange)},
groupChanges:function(g){if(this._isReadOnly())return false;if(this._inChangeGroup){g();return true}this._inChangeGroup=true;this.beganChangeGroup(this,this.editor.buffer._selectedRange);try{g()}catch(j){f.error("Error in groupChanges(): "+j);this._inChangeGroup=false;this.endedChangeGroup(this,this.editor.buffer._selectedRange);return false}finally{this._inChangeGroup=false;this.endedChangeGroup(this,this.editor.buffer._selectedRange);return true}},insertText:function(g){if(this._isReadOnly())return false;
this.groupChanges(function(){var j=a.normalizeRange(this.editor.buffer._selectedRange);this.replaceCharacters(j,g);var n=g.split("\n");this.moveCursorTo(n.length>1?{row:j.start.row+n.length-1,col:n[n.length-1].length}:a.addPositions(j.start,{row:0,col:g.length}))}.bind(this));return true},isDelimiter:function(g){return"\"',;.!~@#$%^&*?[]<>():/\\-+ \t".indexOf(g)!==-1},keyDown:function(g){if(g.charCode===0||g._charCode===0)return this.editor.processKeyEvent(g,this,{isTextView:true});else if(g.keyCode===
9)g.preventDefault();else return false},layoutManagerChangedTextAtRow:function(){this._repositionSelection()},layoutManagerInvalidatedRects:function(g,j){j.forEach(this.invalidateRect,this)},mouseDown:function(g){k.stopEvent(g);this._mouseIsDown=this.hasFocus=true;var j=this.computeWithClippingFrame(g.layerX,g.layerY);k.mixin(j,{layerX:g.layerX,layerY:g.layerY});switch(g.detail){case 1:var n=this._selectionPositionForPoint(j);this.moveCursorTo(n,g.shiftKey);break;case 2:n=this._selectionPositionForPoint(j);
var r=this.editor.layoutManager.textStorage.lines[n.row];if(r.length===0)return true;n.col-=n.col==r.length?1:0;var s=!this.isDelimiter(r[n.col]),w=this,v=function(x,l){for(;x>-1&&x<r.length;x+=l)if(w.isDelimiter(r[x])===s)break;return x+(l==1?0:1)};g=v(n.col,-1);v=v(n.col,1);this.moveCursorTo({row:n.row,col:g});this.moveCursorTo({row:n.row,col:v},true);break;case 3:g=this.editor.layoutManager.textStorage.lines;n=this._selectionPositionForPoint(j);this.setSelection({start:{row:n.row,col:0},end:{row:n.row,
col:g[n.row].length}});break}this._dragPoint=j;this._dragTimer=setInterval(this._scrollWhileDragging.bind(this),100)},mouseMove:function(g){if(this._mouseIsDown){this._dragPoint=this.computeWithClippingFrame(g.layerX,g.layerY);k.mixin(this._dragPoint,{layerX:g.layerX,layerY:g.layerY});this._drag()}},mouseUp:function(){this._mouseIsDown=false;if(this._dragTimer!==null){clearInterval(this._dragTimer);this._dragTimer=null}},moveCursorTo:function(g,j,n){var r=this.editor.layoutManager.textStorage,s=r.clampPosition(g);
this.setSelection({start:j?this.editor.buffer._selectedRange.start:s,end:s});if(n){j=r.lines.length;n=g.row;r=g.col;this.editor.buffer._selectedRangeEndVirtual=n>0&&n<j?g:{row:n<1?0:j-1,col:r}}else this.editor.buffer._selectedRangeEndVirtual=null;this.scrollToPosition(this.editor.buffer._selectedRange.end)},moveDown:function(){var g=this._getVirtualSelection();g=a.normalizeRange(g);g=this._rangeIsInsertionPoint(this.editor.buffer._selectedRange)?g.end:{row:g.end.row,col:g.start.col};g=a.addPositions(g,
{row:1,col:0});this.moveCursorTo(g,false,true)},moveLeft:function(){var g=a.normalizeRange(this.editor.buffer._selectedRange);this._rangeIsInsertionPoint(g)?this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(g.start,-1)):this.moveCursorTo(g.start)},moveRight:function(){var g=a.normalizeRange(this.editor.buffer._selectedRange);this._rangeIsInsertionPoint(g)?this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(g.end,1)):this.moveCursorTo(g.end)},moveUp:function(){var g=
a.normalizeRange(this._getVirtualSelection(true));position=a.addPositions({row:g.start.row,col:this._getVirtualSelection().end.col},{row:-1,col:0});this.moveCursorTo(position,false,true)},parentViewFrameChanged:function(){arguments.callee.base.apply(this,arguments);this._resize()},replaceCharacters:function(g,j){if(this._isReadOnly())return false;this.groupChanges(function(){g=a.normalizeRange(g);this.willReplaceRange(this,g);this.editor.layoutManager.textStorage.replaceCharacters(g,j);this.replacedCharacters(this,
g,j)}.bind(this));return true},performBackspaceOrDelete:function(g){if(this._isReadOnly())return false;var j=this.editor.layoutManager.textStorage,n=j.lines,r="";r=0;var s=d.get("tabstop"),w=this.getSelectedRange();if(a.isZeroLength(w))if(g){g=w.start;r=n[g.row];r=r.substring(0,g.col).match(/\s*$/)[0].length<s||(g.col-s)%s!=0?1:s;w={start:j.displacePosition(g,r*-1),end:w.end}}else{g=w.end;r=n[g.row];r=r.substring(g.col).match(/^\s*/)[0].length<s?1:s;w={start:w.start,end:j.displacePosition(w.end,r)}}this.groupChanges(function(){this.replaceCharacters(w,
"");this.moveCursorTo(w.start)}.bind(this));return true},resetKeyBuffers:function(){this._keyMetaBuffer=this._keyBuffer=""},scrollPageDown:function(){this._scrollPage(false)},scrollPageUp:function(){this._scrollPage(true)},scrollToPosition:function(g){var j=this.editor.layoutManager.characterRectForPosition(g);g=j.x;var n=j.y,r=j.width;j=j.height;var s=this.clippingFrame,w=s.x,v=s.y,x=this.padding,l=s.width-x.right;s=s.height-x.bottom;this.editor.scrollTo({x:g>=w+30&&g+r<w+l?w:g-l/2+r/2,y:n>=v&&n+
j<v+s?v:n-s/2+j/2})},selectAll:function(){var g=this.editor.layoutManager.textStorage.lines,j=g.length-1;this.setSelection({start:{row:0,col:0},end:{row:j,col:g[j].length}})},selectDown:function(){this._performVerticalKeyboardSelection(1)},selectLeft:function(){this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(this.editor.buffer._selectedRange.end,-1),true)},selectRight:function(){this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(this.editor.buffer._selectedRange.end,
1),true)},selectUp:function(){this._performVerticalKeyboardSelection(-1)},setSelection:function(g,j){var n=this.editor.layoutManager.textStorage;g=n.clampRange(g);if(!a.equal(g,this.editor.buffer._selectedRange)){this._invalidateSelection();this.editor.buffer._selectedRange=g=n.clampRange(g);this._invalidateSelection();this._hasFocus&&this._rearmInsertionPointBlinkTimer();j&&this.scrollToPosition(g.end);this.selectionChanged(g);o.publish(this.editor,"editorChange","selection",g)}},textInserted:function(g){if(g!==
"\n")if(!this.editor.processKeyEvent(g,this,{isTextView:true,isCommandKey:false})){this.insertText(g);this.resetKeyBuffers()}},_setFocus:function(g,j){if(g!=this._hasFocus)if(this._hasFocus=g){this._rearmInsertionPointBlinkTimer();this._invalidateSelection();j||this.textInput.focus()}else{if(this._insertionPointBlinkTimer){clearInterval(this._insertionPointBlinkTimer);this._insertionPointBlinkTimer=null}this._insertionPointVisible=true;this._invalidateSelection();j||this.textInput.blur()}}});Object.defineProperties(m.TextView.prototype,
{hasFocus:{get:function(){return this._hasFocus},set:function(g){this._setFocus(g,false)}}})});
bespin.tiki.module("text_editor:views/textinput",function(q,m){var o=q("bespin:util/util");q("events");var k=q("keyboard:keyutil");m.TextInput=function(h,e){var a=this.domNode=document.createElement("textarea");a.setAttribute("style","position: absolute; z-index: -99999; width: 0px; height: 0px; margin: 0px; outline: none; border: 0;");h.appendChild(a);this.delegate=e;this._attachEvents()};m.TextInput.prototype={_composing:false,domNode:null,delegate:null,_textFieldChanged:function(){if(!(this._composing||
this._ignore)){var h=this.domNode,e=h.value;if(e!=""){h.value="";this._textInserted(e)}}},_copy:function(){var h=false,e=this.delegate;if(e&&e.copy)h=e.copy();return h},_cut:function(){var h=false,e=this.delegate;if(e&&e.cut)h=e.cut();return h},_textInserted:function(h){var e=this.delegate;e&&e.textInserted&&e.textInserted(h)},_setValueAndSelect:function(h){var e=this.domNode;e.value=h;e.select()},focus:function(){this.domNode.focus()},blur:function(){this.domNode.blur()},_attachEvents:function(){var h=
this.domNode,e=this;h.addEventListener("focus",function(){e.delegate&&e.delegate.didFocus&&e.delegate.didFocus()},false);h.addEventListener("blur",function(){e.delegate&&e.delegate.didBlur&&e.delegate.didBlur()},false);k.addKeyDownListener(h,function(d){return e.delegate&&e.delegate.keyDown?e.delegate.keyDown(d):false});if(o.isWebKit){o.isChrome||h.addEventListener("compositionend",function(d){e._textInserted(d.data)},false);h.addEventListener("textInput",function(d){e._textInserted(d.data)},false);
h.addEventListener("paste",function(d){e._textInserted(d.clipboardData.getData("text/plain"));d.preventDefault()},false)}else{var a=e._textFieldChanged.bind(e);h.addEventListener("keydown",function(){window.setTimeout(a,0)},false);h.addEventListener("keypress",a,false);h.addEventListener("keyup",a,false);h.addEventListener("compositionstart",function(){e._composing=true},false);h.addEventListener("compositionend",function(){e._composing=false;e._textFieldChanged()},false);h.addEventListener("paste",
function(){e._setValueAndSelect("");window.setTimeout(function(){e._textFieldChanged()},0)},false)}var b=function(d){d=d.type.indexOf("copy")!=-1?e._copy():e._cut();e._setValueAndSelect(d)};if(o.isWebKit&&!o.isChrome&&o.isMac){var i=(new Date).getTime(),f=function(d){var g=d.type.indexOf("cut")!=-1;if(!(g&&(new Date).getTime()-i<10)){b(d);if(g)i=(new Date).getTime()}};h.addEventListener("beforecopy",f,false);h.addEventListener("beforecut",f,false)}else{f=false;if(o.isMozilla)f=function(d){b(d);e._ignore=
true;window.setTimeout(function(){e._setValueAndSelect("");e._ignore=false},0)};h.addEventListener("copy",f||b,false);h.addEventListener("cut",f||b,false)}}}});bespin.tiki.module("text_editor:index",function(){});bespin.tiki.register("::less",{name:"less",dependencies:{}});
bespin.tiki.module("less:index",function(q,m){function o(a){if(a instanceof e.Dimension)return parseFloat(a.unit=="%"?a.value/100:a.value);else if(typeof a==="number")return a;else throw{error:"RuntimeError",message:"color functions take numbers as parameters"};}function k(a){return Math.min(1,Math.max(0,a))}if(!Array.isArray)Array.isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"||a instanceof Array};if(!Array.prototype.forEach)Array.prototype.forEach=function(a,b){for(var i=
this.length>>>0,f=0;f<i;f++)f in this&&a.call(b,this[f],f,this)};if(!Array.prototype.map)Array.prototype.map=function(a,b){for(var i=this.length>>>0,f=new Array(i),d=0;d<i;d++)if(d in this)f[d]=a.call(b,this[d],d,this);return f};if(!Array.prototype.filter)Array.prototype.filter=function(a,b){for(var i=[],f=0;f<this.length;f++)a.call(b,this[f])&&i.push(this[f]);return i};if(!Array.prototype.reduce)Array.prototype.reduce=function(a){var b=this.length>>>0,i=0;if(b===0&&arguments.length===1)throw new TypeError;
if(arguments.length>=2)var f=arguments[1];else{do{if(i in this){f=this[i++];break}if(++i>=b)throw new TypeError;}while(1)}for(;i<b;i++)if(i in this)f=a.call(null,f,this[i],i,this);return f};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a,b){var i=this.length;b=b||0;if(!i)return-1;if(b>=i)return-1;if(b<0)b+=i;for(;b<i;b++)if(Object.prototype.hasOwnProperty.call(this,b))if(a===this[b])return b;return-1};if(!Object.keys)Object.keys=function(a){var b=[];for(var i in a)Object.prototype.hasOwnProperty.call(a,
i)&&b.push(i);return b};if(!String.prototype.trim)String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")};if(typeof q!=="undefined")var h=m,e={};else h=e={};h.Parser=function(a){function b(l){var p,t,u;if(l instanceof Function)return l.call(s.parsers);else if(typeof l==="string"){p=f.charAt(d)===l?l:null;t=1}else{if(d>=r+n[g].length&&g<n.length-1)r+=n[g++].length;l.lastIndex=u=d-r;if(p=l.exec(n[g])){t=p[0].length;if(l.lastIndex-t!==u)return}}if(p){d+=t;for(t=
r+n[g].length;d<=t;){l=f.charCodeAt(d);if(!(l===32||l===10||l===9))break;d++}return typeof p==="string"?p:p.length===1?p[0]:p}}function i(l){var p;if(typeof l==="string")return f.charAt(d)===l;else{l.lastIndex=d;if((p=l.exec(f))&&l.lastIndex-p[0].length===d)return p}}var f,d,g,j,n,r,s,w=this,v=function(){},x=this.imports={paths:a&&a.paths||[],queue:[],files:{},push:function(l,p){var t=this;this.queue.push(l);h.Parser.importer(l,this.paths,function(u){t.queue.splice(t.queue.indexOf(l),1);t.files[l]=
u;p(u);t.queue.length===0&&v()})}};this.env=a||{};this.optimization="optimization"in this.env?this.env.optimization:1;return s={imports:x,parse:function(l,p){var t,u,A=null;d=g=r=j=0;n=[];f=l.replace(/\r\n/g,"\n");if(w.optimization>0){f=f.replace(/\/\*(?:[^*]|\*+[^\/*])*\*+\//g,function(G){return w.optimization>1?"":G.replace(/\n(\s*\n)+/g,"\n")});n=f.split(/^(?=\n)/mg)}else n=[f];t=new e.Ruleset([],b(this.parsers.primary));t.root=true;t.toCSS=function(G){var I,J;return function(){try{return G.call(this)}catch(K){J=
f.split("\n");I=(f.slice(0,K.index).match(/\n/g)||"").length+1;for(var L=K.index,M=-1;L>=0&&f.charAt(L)!=="\n";L--)M++;throw{name:"NameError",message:K.message,line:I,column:M,extract:[J[I-2],J[I-1],J[I]]};}}}(t.toCSS);if(d<f.length-1){d=j;u=f.split("\n");l=(f.slice(0,d).match(/\n/g)||"").length+1;for(var E=d,B=-1;E>=0&&f.charAt(E)!=="\n";E--)B++;A={name:"ParseError",message:"Syntax Error on line "+l,filename:a.filename,line:l,column:B,extract:[u[l-2],u[l-1],u[l]]}}if(this.imports.queue.length>0)v=
function(){p(A,t)};else p(A,t)},parsers:{primary:function(){for(var l,p=[];l=b(this.mixin.definition)||b(this.rule)||b(this.ruleset)||b(this.mixin.call)||b(this.comment)||b(/[\n\s]+/g)||b(this.directive);)p.push(l);return p},comment:function(){var l;if(f.charAt(d)==="/")return(l=b(/\/\*(?:[^*]|\*+[^\/*])*\*+\/\n?/g))?new e.Comment(l):b(/\/\/.*/g)},entities:{quoted:function(){var l;if(!(f.charAt(d)!=='"'&&f.charAt(d)!=="'"))if(l=b(/"((?:[^"\\\r\n]|\\.)*)"|'((?:[^'\\\r\n]|\\.)*)'/g))return new e.Quoted(l[0],
l[1]||l[2])},keyword:function(){var l;if(l=b(/[A-Za-z-]+/g))return new e.Keyword(l)},call:function(){var l,p;if(l=b(/([a-zA-Z0-9_-]+|%)\(/g)){if(l[1].toLowerCase()==="alpha")return b(this.alpha);p=b(this.entities.arguments);if(b(")"))if(l)return new e.Call(l[1],p)}},arguments:function(){for(var l=[],p;p=b(this.expression);){l.push(p);if(!b(","))break}return l},literal:function(){return b(this.entities.dimension)||b(this.entities.color)||b(this.entities.quoted)},url:function(){var l;if(!(f.charAt(d)!==
"u"||!b(/url\(/g))){l=b(this.entities.quoted)||b(/[-a-zA-Z0-9_%@$\/.&=:;#+?]+/g);if(!b(")"))throw new Error("missing closing ) for url()");return new e.URL(l.value?l:new e.Anonymous(l))}},variable:function(){var l,p=d;if(f.charAt(d)==="@"&&(l=b(/@[a-zA-Z0-9_-]+/g)))return new e.Variable(l,p)},color:function(){var l;if(f.charAt(d)==="#"&&(l=b(/#([a-fA-F0-9]{6}|[a-fA-F0-9]{3})/g)))return new e.Color(l[1])},dimension:function(){var l;l=f.charCodeAt(d);if(!(l>57||l<45||l===47))if(l=b(/(-?[0-9]*\.?[0-9]+)(px|%|em|pc|ex|in|deg|s|ms|pt|cm|mm)?/g))return new e.Dimension(l[1],
l[2])}},variable:function(){var l;if(f.charAt(d)==="@"&&(l=b(/(@[a-zA-Z0-9_-]+)\s*:/g)))return l[1]},shorthand:function(){var l,p;if(i(/[@\w.-]+\/[@\w.-]+/g))if((l=b(this.entity))&&b("/")&&(p=b(this.entity)))return new e.Shorthand(l,p)},mixin:{call:function(){for(var l=[],p,t,u,A=d;p=b(/[#.][a-zA-Z0-9_-]+/g);){l.push(new e.Element(t,p));t=b(">")}b("(")&&(u=b(this.entities.arguments))&&b(")");if(l.length>0&&(b(";")||i("}")))return new e.mixin.Call(l,u,A)},definition:function(){var l,p=[],t,u;if(!(f.charAt(d)!==
"."||i(/[^{]*(;|})/g)))if(l=b(/([#.][a-zA-Z0-9_-]+)\s*\(/g)){for(l=l[1];t=b(/@[\w-]+/g)||b(this.entities.literal)||b(this.entities.keyword);){if(t[0]==="@")if(b(":"))if(u=b(this.expression))p.push({name:t,value:u});else throw new Error("Expected value");else p.push({name:t});else p.push({value:t});if(!b(","))break}if(!b(")"))throw new Error("Expected )");if(t=b(this.block))return new e.mixin.Definition(l,p,t)}}},entity:function(){return b(this.entities.literal)||b(this.entities.variable)||b(this.entities.url)||
b(this.entities.call)||b(this.entities.keyword)},end:function(){return b(";")||i("}")},alpha:function(){var l;if(b(/opacity=/gi))if(l=b(/[0-9]+/g)||b(this.entities.variable)){if(!b(")"))throw new Error("missing closing ) for alpha()");return new e.Alpha(l)}},element:function(){var l;c=b(this.combinator);if(l=b(/[.#:]?[a-zA-Z0-9_-]+/g)||b("*")||b(this.attribute)||b(/\([^)@]+\)/g))return new e.Element(c,l)},combinator:function(){var l;return(l=b(/[+>~]/g)||b("&")||b(/::/g))?new e.Combinator(l):new e.Combinator(f.charAt(d-
1)===" "?" ":null)},selector:function(){for(var l,p=[];l=b(this.element);)p.push(l);if(p.length>0)return new e.Selector(p)},tag:function(){return b(/[a-zA-Z][a-zA-Z-]*[0-9]?/g)||b("*")},attribute:function(){var l="",p,t,u;if(b("[")){if(p=b(/[a-z-]+/g)||b(this.entities.quoted))l=(u=b(/[|~*$^]?=/g))&&(t=b(this.entities.quoted)||b(/[\w-]+/g))?[p,u,t.toCSS?t.toCSS():t].join(""):p;if(b("]"))if(l)return"["+l+"]"}},block:function(){var l;if(b("{")&&(l=b(this.primary))&&b("}"))return l},ruleset:function(){var l=
[],p,t,u=d;if(p=i(/([a-z.#: _-]+)[\s\n]*\{/g)){d+=p[0].length-1;l=[new e.Selector([new e.Element(null,p[1])])]}else{for(;p=b(this.selector);){l.push(p);if(!b(","))break}p&&b(this.comment)}if(l.length>0&&(t=b(this.block)))return new e.Ruleset(l,t);else{j=d;d=u}},rule:function(){var l,p=d;if(name=b(this.property)||b(this.variable)){if(name.charAt(0)!="@"&&(match=i(/([^@+\/*(;{}-]*);/g))){d+=match[0].length-1;l=new e.Anonymous(match[1])}else l=name==="font"?b(this.font):b(this.value);if(b(this.end))return new e.Rule(name,
l,p);else{j=d;d=p}}},"import":function(){var l;if(b(/@import\s+/g)&&(l=b(this.entities.quoted)||b(this.entities.url))&&b(";"))return new e.Import(l,x)},directive:function(){var l,p,t;if(f.charAt(d)==="@")if(p=b(this["import"]))return p;else if(l=b(/@media|@page/g)){t=b(/[^{]+/g).trim();if(p=b(this.block))return new e.Directive(l+" "+t,p)}else if(l=b(/@[-a-z]+/g))if(l==="@font-face"){if(p=b(this.block))return new e.Directive(l,p)}else if((p=b(this.entity))&&b(";"))return new e.Directive(l,p)},font:function(){for(var l=
[],p=[],t;t=b(this.shorthand)||b(this.entity);)p.push(t);l.push(new e.Expression(p));if(b(","))for(;t=b(this.expression);){l.push(t);if(!b(","))break}return new e.Value(l,b(this.important))},value:function(){for(var l,p=[];l=b(this.expression);){p.push(l);if(!b(","))break}l=b(this.important);if(p.length>0)return new e.Value(p,l)},important:function(){return b(/!\s*important/g)},sub:function(){var l;if(b("(")&&(l=b(this.expression))&&b(")"))return l},multiplication:function(){var l,p,t,u;if(l=b(this.operand)){for(;(t=
b(/[\/*]/g))&&(p=b(this.operand));)u=new e.Operation(t,[u||l,p]);return u||l}},addition:function(){var l,p,t,u;if(l=b(this.multiplication)){for(;(t=b(/[-+]\s+/g)||f.charAt(d-1)!=" "&&b(/[-+]/g))&&(p=b(this.multiplication));)u=new e.Operation(t,[u||l,p]);return u||l}},operand:function(){return b(this.sub)||b(this.entities.dimension)||b(this.entities.color)||b(this.entities.variable)},expression:function(){for(var l,p=[];l=b(this.addition)||b(this.entity);)p.push(l);if(p.length>0)return new e.Expression(p)},
property:function(){var l;if(l=b(/(\*?-?[-a-z_0-9]+)\s*:/g))return l[1]}}}};h.Parser.importer=null;e.functions={rgb:function(a,b,i){return this.rgba(a,b,i,1)},rgba:function(a,b,i,f){a=[a,b,i].map(function(d){return o(d)});f=o(f);return new e.Color(a,f)},hsl:function(a,b,i){return this.hsla(a,b,i,1)},hsla:function(a,b,i,f){function d(n){n=n<0?n+1:n>1?n-1:n;return n*6<1?j+(g-j)*n*6:n*2<1?g:n*3<2?j+(g-j)*(2/3-n)*6:j}a=(o(a)%360+360)%360/360;b=o(b);i=o(i);f=o(f);var g=i<=0.5?i*(b+1):i+b-i*b,j=i*2-g;return this.rgba(d(a+
1/3)*255,d(a)*255,d(a-1/3)*255,f)},opacity:function(a,b){o(b);return new e.Color(a.rgb,o(b))},saturate:function(a,b){a=a.toHSL();a.s+=b.value/100;a.s=k(a.s);return this.hsl(a.h,a.s,a.l)},desaturate:function(a,b){a=a.toHSL();a.s-=b.value/100;a.s=k(a.s);return this.hsl(a.h,a.s,a.l)},lighten:function(a,b){a=a.toHSL();a.l*=1+b.value/100;a.l=k(a.l);return this.hsl(a.h,a.s,a.l)},darken:function(a,b){a=a.toHSL();a.l*=1-b.value/100;a.l=k(a.l);return this.hsl(a.h,a.s,a.l)},greyscale:function(a){return this.desaturate(a,
new e.Dimension(100))},e:function(a){return new e.Anonymous(a)},"%":function(a){for(var b=Array.prototype.slice.call(arguments,1),i=a.content,f=0;f<b.length;f++)i=i.replace(/%s/,b[f].content).replace(/%[da]/,b[f].toCSS());i=i.replace(/%%/g,"%");return new e.Quoted('"'+i+'"',i)}};e.Alpha=function(a){this.value=a};e.Alpha.prototype={toCSS:function(){return"alpha(opacity="+this.value.toCSS()+")"},eval:function(){return this}};e.Anonymous=function(a){this.value=a.content||a};e.Anonymous.prototype={toCSS:function(){return this.value},
eval:function(){return this}};e.Call=function(a,b){this.name=a;this.args=b};e.Call.prototype={eval:function(a){var b=this.args.map(function(i){return i.eval(a)});return this.name in e.functions?e.functions[this.name].apply(e.functions,b):new e.Anonymous(this.name+"("+b.map(function(i){return i.toCSS()}).join(", ")+")")},toCSS:function(a){return this.eval(a).toCSS()}};e.Color=function(a,b){if(Array.isArray(a)){this.rgb=a;this.alpha=b}else this.rgb=a.length==6?a.match(/.{2}/g).map(function(i){return parseInt(i,
16)}):a.split("").map(function(i){return parseInt(i+i,16)})};e.Color.prototype={eval:function(){return this},toCSS:function(){return this.alpha&&this.alpha<1?"rgba("+this.rgb.concat(this.alpha).join(", ")+")":"#"+this.rgb.map(function(a){a=Math.round(a);a=(a>255?255:a<0?0:a).toString(16);return a.length===1?"0"+a:a}).join("")},operate:function(a,b){var i=[];b instanceof e.Color||(b=b.toColor());for(var f=0;f<3;f++)i[f]=e.operate(a,this.rgb[f],b.rgb[f]);return new e.Color(i)},toHSL:function(){var a=
this.rgb[0]/255,b=this.rgb[1]/255,i=this.rgb[2]/255,f=Math.max(a,b,i),d=Math.min(a,b,i),g,j=(f+d)/2,n=f-d;if(f===d)g=d=0;else{d=j>0.5?n/(2-f-d):n/(f+d);switch(f){case a:g=(b-i)/n+(b<i?6:0);break;case b:g=(i-a)/n+2;break;case i:g=(a-b)/n+4;break}g/=6}return{h:g*360,s:d,l:j}}};e.Comment=function(a){this.value=a};e.Comment.prototype={toCSS:function(){return this.value}};e.Dimension=function(a,b){this.value=parseFloat(a);this.unit=b||null};e.Dimension.prototype={eval:function(){return this},toColor:function(){return new e.Color([this.value,
this.value,this.value])},toCSS:function(){return this.value+this.unit},operate:function(a,b){return new e.Dimension(e.operate(a,this.value,b.value),this.unit||b.unit)}};e.Directive=function(a,b){this.name=a;if(Array.isArray(b))this.ruleset=new e.Ruleset([],b);else this.value=b};e.Directive.prototype={toCSS:function(a,b){if(this.ruleset){this.ruleset.root=true;return this.name+" {\n  "+this.ruleset.toCSS(a,b).trim().replace(/\n/g,"\n  ")+"\n}\n"}else return this.name+" "+this.value.toCSS()+";\n"},
eval:function(a){a.frames.unshift(this);this.ruleset&&this.ruleset.evalRules(a);a.frames.shift();return this},variable:function(a){return e.Ruleset.prototype.variable.call(this.ruleset,a)},find:function(){return e.Ruleset.prototype.find.apply(this.ruleset,arguments)},rulesets:function(){return e.Ruleset.prototype.rulesets.apply(this.ruleset)}};e.Element=function(a,b){this.combinator=a instanceof e.Combinator?a:new e.Combinator(a);this.value=b.trim()};e.Element.prototype.toCSS=function(){return this.combinator.toCSS()+
this.value};e.Combinator=function(a){this.value=a===" "?" ":a?a.trim():""};e.Combinator.prototype.toCSS=function(){switch(this.value){case "":return"";case " ":return" ";case "&":return"";case ":":return" :";case "::":return"::";case "+":return" + ";case "~":return" ~ ";case ">":return" > "}};e.Expression=function(a){this.value=a};e.Expression.prototype={eval:function(a){return this.value.length>1?new e.Expression(this.value.map(function(b){return b.eval(a)})):this.value[0].eval(a)},toCSS:function(){return this.value.map(function(a){return a.toCSS()}).join(" ")}};
e.Import=function(a,b){var i=this;this._path=a;this.path=a instanceof e.Quoted?/\.(le?|c)ss$/.test(a.content)?a.content:a.content+".less":a.value.content||a.value;(this.css=/css$/.test(this.path))||b.push(this.path,function(f){i.root=f})};e.Import.prototype={toCSS:function(){return this.css?"@import "+this._path.toCSS()+";\n":""},eval:function(){if(this.css)return this;else{for(var a=0;a<this.root.rules.length;a++)this.root.rules[a]instanceof e.Import&&Array.prototype.splice.apply(this.root.rules,
[a,1].concat(this.root.rules[a].eval()));return this.root.rules}}};e.Keyword=function(a){this.value=a};e.Keyword.prototype={eval:function(){return this},toCSS:function(){return this.value}};e.mixin={};e.mixin.Call=function(a,b,i){this.selector=new e.Selector(a);this.arguments=b;this.index=i};e.mixin.Call.prototype={eval:function(a){for(var b,i=[],f=false,d=0;d<a.frames.length;d++)if((b=a.frames[d].find(this.selector)).length>0){for(d=0;d<b.length;d++)if(b[d].match(this.arguments,a))try{Array.prototype.push.apply(i,
b[d].eval(this.arguments,a).rules);f=true}catch(g){throw{message:g.message,index:this.index};}if(f)return i;else throw{message:"No matching definition was found for `"+this.selector.toCSS().trim()+"("+this.arguments.map(function(j){return j.toCSS()}).join(", ")+")`",index:this.index};}throw{message:this.selector.toCSS().trim()+" is undefined",index:this.index};}};e.mixin.Definition=function(a,b,i){this.name=a;this.selectors=[new e.Selector([new e.Element(null,a)])];this.params=b;this.arity=b.length;
this.rules=i;this._lookups={};this.required=b.reduce(function(f,d){return d.name&&!d.value?f+1:f},0)};e.mixin.Definition.prototype={toCSS:function(){return""},variable:function(a){return e.Ruleset.prototype.variable.call(this,a)},find:function(){return e.Ruleset.prototype.find.apply(this,arguments)},rulesets:function(){return e.Ruleset.prototype.rulesets.apply(this)},eval:function(a,b){for(var i=new e.Ruleset(null,[]),f=0,d;f<this.params.length;f++)if(this.params[f].name)if(d=a&&a[f]||this.params[f].value)i.rules.unshift(new e.Rule(this.params[f].name,
d.eval(b)));else throw{message:"wrong number of arguments for "+this.name+" ("+a.length+" for "+this.arity+")"};return(new e.Ruleset(null,this.rules)).evalRules({frames:[this,i].concat(b.frames)})},match:function(a,b){var i=a&&a.length||0;if(i<this.required)return false;for(var f=0;f<Math.min(i,this.arity);f++)if(!this.params[f].name)if(!a[f].wildcard)if(a[f].eval(b).toCSS()!=this.params[f].value.eval(b).toCSS())return false;return true}};e.Operation=function(a,b){this.op=a.trim();this.operands=b};
e.Operation.prototype.eval=function(a){var b=this.operands[0].eval(a);a=this.operands[1].eval(a);var i;if(b instanceof e.Dimension&&a instanceof e.Color)if(this.op==="*"||this.op==="+"){i=a;a=b;b=i}else throw{name:"OperationError",message:"Can't substract or divide a color from a number"};return b.operate(this.op,a)};e.operate=function(a,b,i){switch(a){case "+":return b+i;case "-":return b-i;case "*":return b*i;case "/":return b/i}};e.Quoted=function(a,b){this.value=a;this.content=b};e.Quoted.prototype=
{toCSS:function(){return this.value},eval:function(){return this}};e.Rule=function(a,b,i){this.name=a;this.value=b instanceof e.Value?b:new e.Value([b]);this.index=i;this.variable=a.charAt(0)==="@"?true:false};e.Rule.prototype.toCSS=function(){return this.variable?"":this.name+": "+this.value.toCSS()+";"};e.Rule.prototype.eval=function(a){return new e.Rule(this.name,this.value.eval(a))};e.Value=function(a){this.value=a;this.is="value"};e.Value.prototype={eval:function(a){return this.value.length===
1?this.value[0].eval(a):new e.Value(this.value.map(function(b){return b.eval(a)}))},toCSS:function(){return this.value.map(function(a){return a.toCSS()}).join(", ")}};e.Shorthand=function(a,b){this.a=a;this.b=b};e.Shorthand.prototype={toCSS:function(a){return this.a.toCSS(a)+"/"+this.b.toCSS(a)},eval:function(){return this}};e.Ruleset=function(a,b){this.selectors=a;this.rules=b;this._lookups={}};e.Ruleset.prototype={eval:function(){return this},evalRules:function(a){var b=[];this.rules.forEach(function(i){if(i.evalRules)b.push(i.evalRules(a));
else i instanceof e.mixin.Call?Array.prototype.push.apply(b,i.eval(a)):b.push(i.eval(a))});this.rules=b;return this},match:function(a){return!a||a.length===0},variable:function(a){return this._variables?this._variables[a]:(this._variables=this.rules.reduce(function(b,i){if(i instanceof e.Rule&&i.variable===true)b[i.name]=i;return b},{}))[a]},rulesets:function(){return this._rulesets?this._rulesets:(this._rulesets=this.rules.filter(function(a){if(a instanceof e.Ruleset||a instanceof e.mixin.Definition)return a}))},
find:function(a,b){b=b||this;var i=[],f=a.toCSS();if(f in this._lookups)return this._lookups[f];this.rulesets().forEach(function(d){if(d!==b)for(var g=0;g<d.selectors.length;g++)if(a.match(d.selectors[g])){a.elements.length>1?Array.prototype.push.apply(i,d.find(new e.Selector(a.elements.slice(1)),b)):i.push(d);break}});return this._lookups[f]=i},toCSS:function(a,b){var i=[],f=[],d=[],g=[];if(this.root){a=[];b={frames:[]};for(var j=0;j<this.rules.length;j++)this.rules[j]instanceof e.Import&&Array.prototype.splice.apply(this.rules,
[j,1].concat(this.rules[j].eval(b)))}else if(a.length===0)g=this.selectors.map(function(r){return[r]});else for(j=0;j<this.selectors.length;j++)for(var n=0;n<a.length;n++)g.push(a[n].concat([this.selectors[j]]));b.frames.unshift(this);for(j=0;j<this.rules.length;j++)this.rules[j]instanceof e.mixin.Call&&Array.prototype.splice.apply(this.rules,[j,1].concat(this.rules[j].eval(b)));for(j=0;j<this.rules.length;j++){a=this.rules[j];if(a instanceof e.Directive)d.push(a.eval(b).toCSS(g,b));else if(a.rules)d.push(a.toCSS(g,
b));else if(a instanceof e.Comment)this.root?d.push(a.toCSS()):f.push(a.toCSS());else if(a.toCSS&&!a.variable)f.push(a.eval(b).toCSS());else a.value&&!a.variable&&f.push(a.value.toString())}d=d.join("");if(this.root)i.push(f.join("\n"));else if(f.length>0){g=g.map(function(r){return r.map(function(s){return s.toCSS()}).join("").trim()}).join(g.length>3?",\n":", ");i.push(g," {\n  "+f.join("\n  ")+"\n}\n")}i.push(d);b.frames.shift();return i.join("")}};e.Selector=function(a){this.elements=a;if(this.elements[0].combinator.value===
"")this.elements[0].combinator.value=" "};e.Selector.prototype.match=function(a){return this.elements[0].value===a.elements[0].value?true:false};e.Selector.prototype.toCSS=function(){if(this._css)return this._css;return this._css=this.elements.map(function(a){return typeof a==="string"?" "+a.trim():a.toCSS()}).join("")};e.URL=function(a){this.value=a};e.URL.prototype={toCSS:function(){return"url("+this.value.toCSS()+")"},eval:function(){return this}};e.Variable=function(a,b){this.name=a;this.index=
b};e.Variable.prototype={eval:function(a){var b,i,f=this.name;if(b=e.find(a.frames,function(d){if(i=d.variable(f))return i.value.eval(a)}))return b;else throw{message:"variable "+this.name+" is undefined",index:this.index};}};e.find=function(a,b){for(var i=0,f;i<a.length;i++)if(f=b.call(a,a[i]))return f;return null};(function(){function a(s){for(var w=0;w<n.length;w++)b(n[w],s)}function b(s,w){var v=typeof localStorage!=="undefined"&&localStorage.getItem(s.href),x=v&&JSON.parse(v);f(s.href,function(l,
p){if(x&&(new Date(p)).valueOf()===(new Date(x.timestamp)).valueOf()){i(x.css,s);w(null,s,{local:true})}else(new h.Parser({optimization:3})).parse(l,function(t,u){if(t)return j(t,s.href);try{w(u,s,{local:false,lastModified:p})}catch(A){j(A,s.href)}})},function(l){throw new Error("Couldn't load "+s.href+" ("+l+")");})}function i(s,w,v){var x=document.createElement("style");x.type="text/css";x.media="screen";x.title="less-sheet";if(w){x.title=w.title||w.href.match(/(?:^|\/)([-\w]+)\.[a-z]+$/i)[1];v&&
typeof localStorage!=="undefined"&&localStorage.setItem(w.href,JSON.stringify({timestamp:v,css:s}))}if(x.styleSheet)x.styleSheet.cssText=s;else x.appendChild(document.createTextNode(s));document.getElementsByTagName("head")[0].appendChild(x)}function f(s,w,v){var x=d();if(window.location.protocol==="file:"){x.open("GET",s,false);x.send(null);x.status===0?w(x.responseText):v(x.status)}else{x.open("GET",s,true);x.onreadystatechange=function(){if(x.readyState==4)if(x.status>=200&&x.status<300)w(x.responseText,
x.getResponseHeader("Last-Modified"));else typeof v==="function"&&v(x.status)};x.send(null)}}function d(){if(window.XMLHttpRequest)return new XMLHttpRequest;else try{return new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(s){g("less: browser doesn't support AJAX.");return null}}function g(s){h.env=="development"&&typeof console!=="undefined"&&console.log(s)}function j(s,w){var v=document.createElement("div"),x;v.id="less-error-message";v.innerHTML="<h3>"+(s.message||"There is an error in your .less file")+
'</h3><p><a href="'+w+'">'+w+"</a> on line "+s.line+", column "+(s.column+1)+":</p>"+'<div>\n<pre class="ctx"><span>[-1]</span>{0}</pre>\n<pre><span>[0]</span>{current}</pre>\n<pre class="ctx"><span>[1]</span>{2}</pre>\n</div>'.replace(/\[(-?\d)\]/g,function(l,p){return s.line+parseInt(p)}).replace(/\{(\d)\}/g,function(l,p){return s.extract[parseInt(p)]}).replace(/\{current\}/,s.extract[1].slice(0,s.column)+'<span class="error">'+s.extract[1].slice(s.column)+"</span>");i("#less-error-message span {margin-right: 15px;}#less-error-message pre {color: #ee4444;padding: 4px 0;margin: 0;}#less-error-message pre.ctx {color: #dd7777;}#less-error-message h3 {padding: 15px 0 5px 0;margin: 0;}#less-error-message a {color: #10a}#less-error-message .error {color: red;font-weight: bold;padding-bottom: 2px;border-bottom: 1px dashed red;}");
v.style.cssText="font-family: Arial, sans-serif;border: 1px solid #e00;background-color: #eee;border-radius: 5px;color: #e00;padding: 15px;margin-bottom: 15px";if(h.env=="development")x=setInterval(function(){if(document.body){document.body.insertBefore(v,document.body.childNodes[0]);clearInterval(x)}},10)}var n=[];h.env=location.hostname=="127.0.0.1"||location.hostname=="0.0.0.0"||location.hostname=="localhost"||location.protocol=="file:"?"development":"production";var r=setInterval(function(){if(document.body){if(!document.querySelectorAll&&
typeof jQuery==="undefined")g("No selector method found");else n=(document.querySelectorAll||jQuery).call(document,'link[rel="stylesheet/less"]');clearInterval(r);a(function(s,w,v){i(s.toCSS(),w,v.lastModified);v.local?g("less: loading "+w.href+" from local storage."):g("less: parsed "+w.href+" successfully.")})}},10);if(h.env==="development")refreshTimer=setInterval(function(){/!refresh/.test(location.hash)&&a(function(s,w,v){i(s.toCSS(),w,v)})},1E3);h.Parser.importer=function(s,w,v){b({href:s,title:s},
function(x){v(x)})}})()});bespin.tiki.register("::theme_manager_base",{name:"theme_manager_base",dependencies:{}});bespin.tiki.module("theme_manager_base:index",function(){});bespin.tiki.register("::canon",{name:"canon",dependencies:{environment:"0.0.0",events:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("canon:history",function(q,m){var o=q("bespin:util/stacktrace").Trace,k=q("bespin:plugins").catalog;m.requests=[];m.addRequestOutput=function(h){for(m.requests.push(h);m.requests.length>100;)m.requests.shiftObject();k.publish(this,"addedRequestOutput",null,h)};m.execute=function(h,e){if(e.command)try{e.command(h,e)}catch(a){var b=new o(a,true);console.group("Error executing command '"+e.typed+"'");console.log("command=",e.commandExt);console.log("args=",h);console.error(a);b.log(3);
console.groupEnd();e.doneWithError(a)}else e.doneWithError("Command not found.")}});
bespin.tiki.module("canon:request",function(q,m){var o=q("events").Event,k=q("canon:history");m.Request=function(h){h=h||{};this.command=h.command;this.commandExt=h.commandExt;this.args=h.args;this.typed=h.typed;this._begunOutput=false;this.start=new Date;this.end=null;this.error=this.completed=false;this.changed=new o};m.Request.prototype._beginOutput=function(){this._begunOutput=true;this.outputs=[];k.addRequestOutput(this)};m.Request.prototype.doneWithError=function(h){this.error=true;this.done(h)};
m.Request.prototype.async=function(){this._begunOutput||this._beginOutput()};m.Request.prototype.output=function(h){this._begunOutput||this._beginOutput();if(typeof h!=="string"&&!(h instanceof Node))h=h.toString();this.outputs.push(h);this.changed();return this};m.Request.prototype.done=function(h){this.completed=true;this.end=new Date;this.duration=this.end.getTime()-this.start.getTime();h?this.output(h):this.changed()}});bespin.tiki.module("canon:index",function(){});
bespin.tiki.register("::traits",{name:"traits",dependencies:{}});
bespin.tiki.module("traits:index",function(q,m){m.Trait=function(){function o(z){var y=function(){throw new Error("Conflicting property: "+z);};B(y.prototype);return B(y)}function k(){return B({value:undefined,enumerable:false,required:true})}function h(z){z=o(z);return l?B({get:z,set:z,enumerable:false,conflict:true}):B({value:z,enumerable:false,conflict:true})}function e(z,y){return z===y?z!==0||1/z===1/y:z!==z&&y!==y}function a(z,y){return z.conflict&&y.conflict?true:z.get===y.get&&z.set===y.set&&
e(z.value,y.value)&&z.enumerable===y.enumerable&&z.required===y.required&&z.conflict===y.conflict}function b(z,y){return B(t(z,y))}function i(z){var y={};E(z,function(C){y[C]=true});return B(y)}function f(z){var y={};E(G(z),function(C){var D=I(z,C);if(D.value===M)D=k(C);else if(typeof D.value==="function"){D.method=true;"prototype"in D.value&&B(D.value.prototype)}else{D.get&&D.get.prototype&&B(D.get.prototype);D.set&&D.set.prototype&&B(D.set.prototype)}y[C]=D});return y}function d(){var z=A(arguments,
0),y={};E(z,function(C){E(G(C),function(D){var F=C[D];if(u(y,D)&&!y[D].required)F.required||a(y[D],F)||(y[D]=h(D));else y[D]=F})});return B(y)}function g(z,y){var C=i(z),D={};E(G(y),function(F){D[F]=!u(C,F)||y[F].required?y[F]:k(F)});return B(D)}function j(){var z=A(arguments,0),y={};E(z,function(C){E(G(C),function(D){var F=C[D];if(!u(y,D)||y[D].required)y[D]=F})});return B(y)}function n(z,y){var C={};E(G(y),function(D){if(u(z,D)&&!y[D].required){var F=z[D];C[F]=u(C,F)&&!C[F].required?h(F):y[D];u(C,
D)||(C[D]=k(D))}else if(u(C,D))y[D].required||(C[D]=h(D));else C[D]=y[D]});return B(C)}function r(z,y){var C={},D=[];for(var F in z)if(u(z,F))if(z[F])C[F]=z[F];else D.push(F);return n(C,g(D,y))}function s(z,y){var C=L(z),D={};E(G(y),function(F){var H=y[F];if(H.required&&!(F in z))throw new Error("Missing required property: "+F);else if(H.conflict)throw new Error("Remaining conflicting property: "+F);else D[F]="value"in H?H.method?{value:b(H.value,C),enumerable:H.enumerable,configurable:H.configurable,
writable:H.writable}:H:{get:H.get?b(H.get,C):undefined,set:H.set?b(H.set,C):undefined,enumerable:H.enumerable,configurable:H.configurable,writable:H.writable}});K(C,D);return B(C)}function w(z,y){return s(Object.prototype,f(z),y)}function v(z,y){var C=G(z),D=G(y);if(C.length!==D.length)return false;for(var F=0;F<C.length;F++){D=C[F];if(!y[D]||!a(z[D],y[D]))return false}return true}function x(z){return f(z)}var l=!!Object.defineProperty,p=Function.prototype.call,t=Function.prototype.bind?function(z,
y){return Function.prototype.bind.call(z,y)}:function(z,y){function C(){return z.apply(y,arguments)}return C},u=t(p,Object.prototype.hasOwnProperty),A=t(p,Array.prototype.slice),E=Array.prototype.forEach?t(p,Array.prototype.forEach):function(z,y){for(var C=0,D=z.length;C<D;C++)y(z[C])},B=Object.freeze||function(z){return z},G=Object.getOwnPropertyNames||function(z){var y=[];for(var C in z)u(z,C)&&y.push(C);return y},I=Object.getOwnPropertyDescriptor||function(z,y){return{value:z[y],enumerable:true,
writable:true,configurable:true}},J=Object.defineProperty||function(z,y,C){z[y]=C.value},K=Object.defineProperties||function(z,y){for(var C in y)u(y,C)&&J(z,C,y[C])},L=Object.create||function(z,y){function C(){}C.prototype=z||Object.prototype;z=new C;y&&K(z,y);return z};p=Object.getOwnProperties||function(z){var y={};E(G(z),function(C){y[C]=I(z,C)});return y};var M=B({toString:function(){return"<Trait.required>"}});if(!Object.create)Object.create=L;if(!Object.getOwnProperties)Object.getOwnProperties=
p;x.required=B(M);x.compose=B(d);x.resolve=B(r);x.override=B(j);x.create=B(s);x.eqv=B(v);x.object=B(w);return B(x)}()});bespin.tiki.register("::keyboard",{name:"keyboard",dependencies:{canon:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("keyboard:keyboard",function(q,m){var o=q("bespin:plugins").catalog;q("bespin:console");q("bespin:util/stacktrace");var k=q("bespin:util/util"),h=q("settings").settings,e=q("keyboard:keyutil"),a=q("canon:history"),b=q("canon:request").Request,i=q("environment").env;m.buildFlags=function(f){f.context=i.contexts[0];return f};q=function(){};k.mixin(q.prototype,{_customKeymappingCache:{states:{}},processKeyEvent:function(f,d,g){f=e.commandCodes(f,true)[0];if(k.none(f))return false;
m.buildFlags(g);g.isCommandKey=true;return this._matchCommand(f,d,g)},_matchCommand:function(f,d,g){var j=this._findCommandExtension(f,d,g);if(j&&j.commandExt!=="no command"){g.isTextView&&d.resetKeyBuffers();var n=j.commandExt;n.load(function(r){r=new b({command:r,commandExt:n});a.execute(j.args,r)});return true}return j&&j.commandExt==="no command"?true:false},_buildBindingsRegex:function(f){f.forEach(function(d){if(k.none(d.key))if(Array.isArray(d.regex)){d.key=new RegExp("^"+d.regex[1]+"$");d.regex=
new RegExp(d.regex.join("")+"$")}else d.regex=new RegExp(d.regex+"$");else d.key=new RegExp("^"+d.key+"$")})},_buildKeymappingRegex:function(f){for(state in f.states)this._buildBindingsRegex(f.states[state]);f._convertedRegExp=true},_findCommandExtension:function(f,d,g){if(g.isTextView){var j=d._keyState;if(!g.isCommandKey||f.indexOf("alt_")===-1){d._keyBuffer+=f.replace(/ctrl_meta|meta/,"ctrl");d._keyMetaBuffer+=f}var n=[this._customKeymappingCache];n=n.concat(o.getExtensions("keymapping"));for(var r=
0;r<n.length;r++)if(!k.none(n[r].states[j])){k.none(n[r]._convertedRegExp)&&this._buildKeymappingRegex(n[r]);var s=this._bindingsMatch(f,g,d,n[r]);if(!k.none(s))return s}}d=o.getExtensions("command");var w=null;j={};f=f.replace(/ctrl_meta|meta/,"ctrl");d.some(function(v){if(this._commandMatches(v,f,g)){w=v;return true}return false}.bind(this));return k.none(w)?null:{commandExt:w,args:j}},_bindingsMatch:function(f,d,g,j){var n,r=null,s={},w;w=k.none(j.hasMetaKey)?g._keyMetaBuffer:g._keyBuffer;if(f.indexOf("alt_")===
0&&d.isCommandKey)w+=f;j.states[g._keyState].some(function(v){if(v.key&&!v.key.test(f))return false;if(v.regex&&!(n=v.regex.exec(w)))return false;if(v.disallowMatches)for(var x=0;x<v.disallowMatches.length;x++)if(n[v.disallowMatches[x]])return true;if(!m.flagsMatch(v.predicates,d))return false;if(v.exec){r=o.getExtensionByKey("command",v.exec);if(k.none(r))throw new Error("Can't find command "+v.exec+" in state="+g._keyState+", symbolicName="+f);if(v.params){var l;v.params.forEach(function(p){l=!k.none(p.match)&&
!k.none(n)?n[p.match]||p.defaultValue:p.defaultValue;if(p.type==="number")l=parseInt(l);s[p.name]=l})}g.resetKeyBuffers()}if(v.then){g._keyState=v.then;g.resetKeyBuffers()}if(k.none(r))r="no command";return true});if(k.none(r))return null;return{commandExt:r,args:s}},_commandMatches:function(f,d,g){var j=f.key;if(!j)return false;if(!m.flagsMatch(f.predicates,g))return false;if(typeof j==="string"){if(j!=d)return false;return true}if(!Array.isArray(j)){j=[j];f.key=j}for(f=0;f<j.length;f++){var n=j[f];
if(typeof n==="string"){if(n==d)return true}else if(n.key==d)return m.flagsMatch(n.predicates,g)}return false},_customKeymappingChanged:function(){var f=this._customKeymappingCache=JSON.parse(h.get("customKeymapping"));f.states=f.states||{};for(state in f.states)this._buildBindingsRegex(f.states[state]);f._convertedRegExp=true}});m.flagsMatch=function(f,d){if(k.none(f))return true;if(!d)return false;for(var g in f)if(d[g]!==f[g])return false;return true};m.keyboardManager=new q;o.registerExtension("settingChange",
{match:"customKeymapping",pointer:m.keyboardManager._customKeymappingChanged.bind(m.keyboardManager)})});
bespin.tiki.module("keyboard:keyutil",function(q,m){var o=q("bespin:util/util");m.KeyHelper=function(){var h={MODIFIER_KEYS:{16:"shift",17:"ctrl",18:"alt",224:"meta"},FUNCTION_KEYS:{8:"backspace",9:"tab",13:"return",19:"pause",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"insert",46:"delete",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock"},PRINTABLE_KEYS:{32:" ",
48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",107:"+",109:"-",110:".",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:'"'},PRINTABLE_KEYS_CHARCODE:{},KEY:{}};for(var e in h.PRINTABLE_KEYS){var a=h.PRINTABLE_KEYS[e];h.PRINTABLE_KEYS_CHARCODE[a.charCodeAt(0)]=e;if(a.toUpperCase()!=
a)h.PRINTABLE_KEYS_CHARCODE[a.toUpperCase().charCodeAt(0)]=e}for(e in h.FUNCTION_KEYS){a=h.FUNCTION_KEYS[e].toUpperCase();h.KEY[a]=parseInt(e,10)}return h}();var k=function(h){return!!(h.altKey||h.ctrlKey||h.metaKey||h.charCode!==h.which&&m.KeyHelper.FUNCTION_KEYS[h.which])};m.commandCodes=function(h,e){var a=h._keyCode||h.keyCode,b=h._charCode===undefined?h.charCode:h._charCode,i=null,f=null,d="",g=true;if(a===0&&h.which===0)return false;if(b!==0)return false;if(m.KeyHelper.MODIFIER_KEYS[b])return[m.KeyHelper.MODIFIER_KEYS[b],
null];if(a){i=m.KeyHelper.FUNCTION_KEYS[a];if(!i&&(h.altKey||h.ctrlKey||h.metaKey)){i=m.KeyHelper.PRINTABLE_KEYS[a];if(a>47&&a<58)g=h.altKey}if(i){if(h.altKey)d+="alt_";if(h.ctrlKey)d+="ctrl_";if(h.metaKey)d+="meta_"}else if(h.ctrlKey||h.metaKey)return false}if(!i){a=h.which;f=i=String.fromCharCode(a);a=i.toLowerCase();if(h.metaKey){d="meta_";i=a}else i=null}if(h.shiftKey&&i&&g)d+="shift_";if(i)i=d+i;if(!e&&i)i=i.replace(/ctrl_meta|meta/,"ctrl");return[i,f]};m.addKeyDownListener=function(h,e){var a=
function(b){var i=e(b);i&&o.stopEvent(b);return i};h.addEventListener("keydown",function(b){if(o.isMozilla)if(m.KeyHelper.FUNCTION_KEYS[b.keyCode])return true;else if((b.ctrlKey||b.metaKey)&&m.KeyHelper.PRINTABLE_KEYS[b.keyCode])return true;if(k(b))return a(b);return true},false);h.addEventListener("keypress",function(b){if(o.isMozilla)if(m.KeyHelper.FUNCTION_KEYS[b.keyCode])return a(b);else if((b.ctrlKey||b.metaKey)&&m.KeyHelper.PRINTABLE_KEYS_CHARCODE[b.charCode]){b._keyCode=m.KeyHelper.PRINTABLE_KEYS_CHARCODE[b.charCode];
b._charCode=0;return a(b)}if(b.charCode!==undefined&&b.charCode===0)return true;return a(b)},false)}});bespin.tiki.module("keyboard:index",function(){});bespin.tiki.register("::worker_manager",{name:"worker_manager",dependencies:{canon:"0.0.0",events:"0.0.0",underscore:"0.0.0"}});
bespin.tiki.module("worker_manager:index",function(q,m){function o(d){var g=/^([^#:]+)(?::([^#:]+))?#([^#:]+)$/.exec(d);if(g==null)throw new Error('WorkerSupervisor: invalid pointer specification: "'+d+'"');d=g[1];var j=g[3];g=d+":"+(g[2]!=null?g[2]:"index");var n=bespin!=null&&bespin.base!=null?bespin.base:"";this._packageId=d;this._moduleId=g;this._base=n;this._target=j;this._worker=null;this._currentId=0;this.started=new b}function k(){f.restartAll()}if(window==null)throw new Error('The "worker_manager" plugin can only be loaded in the browser, not a web worker. Use "worker" instead.');
var h=q("bespin:proxy");q("bespin:plugins");var e=q("bespin:console").console,a=q("underscore")._,b=q("events").Event,i=q("bespin:promise").Promise;q("environment");var f={_workers:[],add:function(d){this._workers.push(d)},remove:function(d){this._workers=a(this._workers).without(d)},restartAll:function(){var d=this._workers;a(d).invoke("kill");a(d).invoke("start")}};o.prototype={_onError:function(d){this._worker=null;f.remove(this);e.error("WorkerSupervisor: worker failed at file "+d.filename+":"+
d.lineno+"; fix the worker and use 'worker restart' to restart it")},_onMessage:function(d){d=JSON.parse(d.data);switch(d.op){case "finish":if(d.id===this._currentId){var g=this._promise;this._promise=null;g.resolve(d.result)}break;case "log":e[d.method].apply(e,d.args);break}},_promise:null,started:null,kill:function(){var d=this._promise;if(d!=null){d.reject("killed");this._promise=null}this._worker.terminate();this._worker=null;f.remove(this)},send:function(d,g){var j=this._promise;if(j!=null){j.reject("interrupted");
this._currentId++}j=this._currentId;var n=new i;this._promise=n;this._worker.postMessage(JSON.stringify({op:"invoke",id:j,method:d,args:g}));return n},start:function(){if(this._worker!=null)throw new Error("WorkerSupervisor: worker already started");var d=this._base,g=this._target,j=this._packageId,n=this._moduleId,r=new h.Worker(d+"BespinEmbedded.js");r.onmessage=this._onMessage.bind(this);r.onerror=this._onError.bind(this);r.postMessage(JSON.stringify({op:"load",base:d,pkg:j,module:n,target:g}));
this._worker=r;this._currentId=0;f.add(this);this.started()}};m.WorkerSupervisor=o;m.workerManager=f;m.workerRestartCommand=k});bespin.tiki.register("::edit_session",{name:"edit_session",dependencies:{events:"0.0.0"}});
bespin.tiki.module("edit_session:index",function(q,m){q("bespin:promise");q("bespin:plugins");q("bespin:util/util");q("events");m.EditSession=function(){};m.EditSession.prototype={_currentView:null,currentUser:null,history:null,getCompletePath:function(o){if(o==null)o="";if(o==null||o.substring(0,1)!="/"){var k;if(this._currentView&&this._currentView.buffer)k=this._currentView.buffer;var h;if(k)h=k.file;o=h?h.parentdir()+o:"/"+o}return o}};Object.defineProperties(m.EditSession.prototype,{currentView:{set:function(o){if(o!==
this._currentView)this._currentView=o},get:function(){return this._currentView}}});m.createSession=function(o,k){var h=new m.EditSession;if(o)h.currentView=o.textView;if(k)h.currentUser=k;return h}});bespin.tiki.register("::syntax_manager",{name:"syntax_manager",dependencies:{worker_manager:"0.0.0",events:"0.0.0",underscore:"0.0.0",syntax_directory:"0.0.0"}});
bespin.tiki.module("syntax_manager:index",function(q,m){function o(d,g,j,n){for(;d.length<g;)d.push(a(n).clone());g=[g,j.length].concat(j);Array.prototype.splice.apply(d,g);return d}function k(){this._lines=[];this._syms={}}function h(d,g){this._syntaxInfo=d;this._syntaxManager=g;this._invalidRow=0;this._states=[];this._active=false;this.symbols=new k}function e(d){this.layoutManager=d;this.attrsChanged=new b;this.syntaxChanged=new b;this._contextRanges=this._invalidRows=this._context=null;this._attrs=
[];this._symbols=new k;this._syntax="plain";this._reset()}var a=q("underscore")._,b=q("events").Event,i=q("worker_manager").WorkerSupervisor;q("bespin:console");q("rangeutils:utils/range");var f=q("syntax_directory").syntaxDirectory;k.prototype={get:function(d){return this._syms["-"+d]},replaceLine:function(d,g){function j(s){return s.substring(1)}var n=this._lines,r=this._syms;d<n.length&&a(n[d]).isArray()&&a(n[d]).each(function(s){delete r["-"+s]});n[d]=a(g).keys().map(j);a(r).extend(g)}};h.prototype=
{_annotate:function(){if(this._invalidRow==null)throw new Error("syntax_manager.Context: attempt to annotate without any invalid row");if(!this._active)throw new Error("syntax_manager.Context: attempt to annotate while inactive");if(this._worker==null)this._createWorker();else{var d=this._syntaxManager.getTextLines(),g=this._invalidRow,j=g===0?this.getName()+":start":this._states[g],n=Math.min(d.length,g+100);d=d.slice(g,n);var r={start:{row:g,col:0},end:{row:n-1,col:a(d).last().length}};this._worker.send("annotate",
[j,d,r]).then(a(this._annotationFinished).bind(this,g,n))}},_annotationFinished:function(d,g,j){if(this._active){var n=this._syntaxManager;n.mergeAttrs(d,j.attrs);n.mergeSymbols(d,j.symbols);o(this._states,d,j.states);if(g>=this._getRowCount()){this._invalidRow=null;this._active=false}else{this._invalidRow=g;this._annotate()}}},_createWorker:function(){if(this._syntaxInfo==null)return false;var d=new i("syntax_worker#syntaxWorker");this._worker=d;d.started.add(this._workerStarted.bind(this));d.start();
return true},_getRowCount:function(){return this._syntaxManager.getTextLines().length},_workerStarted:function(){this._worker.send("loadSyntax",[this._syntaxInfo.name]);this._active&&this._annotate()},activateAndAnnotate:function(){this._active=true;this._annotate()},contextsAtPosition:function(){var d=this._syntaxInfo;if(d==null)return["plain"];return[d.name]},cut:function(d){var g=this._getRowCount();if(d<0||d>=g)throw new Error("Attempt to cut the context at an invalid row");if(!(this._invalidRow!=
null&&this._invalidRow<d)){this._invalidRow=d;this._active=false}},getName:function(){return this._syntaxInfo.name},kill:function(){var d=this._worker;if(d!=null){d.kill();this._worker=null}}};e.prototype={_getTextStorage:function(){return this.layoutManager.textStorage},_reset:function(){var d=this._context;if(d!=null){d.kill();this._context=null}d=this._syntax;d=d==="plain"?null:f.get(d);this._context=d=new h(d,this);d.activateAndAnnotate()},attrsChanged:null,syntaxChanged:null,contextsAtPosition:function(d){return this._context.contextsAtPosition(d)},
getAttrsForRows:function(d,g){return this._attrs.slice(d,g)},getSymbol:function(d){return this._symbols.get(d)},getSyntax:function(){return this._syntax},getTextLines:function(){return this._getTextStorage().lines},invalidateRow:function(d){var g=this._context;g.cut(d);g.activateAndAnnotate()},mergeAttrs:function(d,g){o(this._attrs,d,g,[]);this.attrsChanged(d,d+g.length)},mergeSymbols:function(d,g){var j=this._symbols;a(g).each(function(n,r){j.replaceLine(d+r,n)})},setSyntax:function(d){this._syntax=
f.hasSyntax(d)?d:"plain";this.syntaxChanged(d);this._reset()},setSyntaxFromFileExt:function(d){return this.setSyntax(f.syntaxForFileExt(d))}};m.SyntaxManager=e});bespin.tiki.register("::completion",{name:"completion",dependencies:{jquery:"0.0.0",ctags:"0.0.0",rangeutils:"0.0.0",canon:"0.0.0",underscore:"0.0.0"}});
bespin.tiki.module("completion:controller",function(q,m){function o(f){this._editorView=f;f.selectionChanged.add(this._selectionChanged.bind(this));f.willChangeBuffer.add(this._willChangeBuffer.bind(this));this._syntaxChanged=this._syntaxChanged.bind(this);this.tags=new h.Tags;this.ui=new a(f.element)}function k(f){return function(){return i.editor.completionController[f](i)}}var h=q("ctags"),e=q("rangeutils:utils/range"),a=q("completion:ui").CompletionUI,b=q("bespin:plugins").catalog,i=q("environment").env;
o.prototype={_buffer:null,_completionEngine:null,_completions:null,_stem:null,_hideCompletions:function(){this.ui.hide()},_selectionChanged:function(f){var d=this._completionEngine;if(!(d==null||!e.isZeroLength(f))){var g=this._buffer.layoutManager,j=g.syntaxManager,n=f.start;f=n.col;n=g.textStorage.lines[n.row];g=n.substring(0,f);f=n.substring(f);d=d.getCompletions(g,f,j);if(d==null)this._hideCompletions();else{j=d.tags;this._stem=d.stem;this._showCompletions(j)}}},_showCompletions:function(f){var d=
this._editorView,g=d.textView.getInsertionPointPosition();g=d.convertTextViewPoint(g);this.ui.show(f,g,d.layoutManager.fontDimension.lineHeight)},_syntaxChanged:function(f){f=b.getExtensionByKey("completion",f);if(f==null)this._completionEngine=null;else f.load().then(function(d){this._completionEngine=new d(this.tags)}.bind(this))},_willChangeBuffer:function(f){var d=this._buffer;d!=null&&d.layoutManager.syntaxManager.syntaxChanged.remove(this._syntaxChanged);f.layoutManager.syntaxManager.syntaxChanged.add(this._syntaxChanged);
this._buffer=f},cancel:function(){this.ui.hide()},complete:function(f){var d=this.ui,g=d.getCompletion().name;f.view.insertText(g.substring(this._stem.length));d.hide()},isCompleting:function(){return this.ui.visible},moveDown:function(){this.ui.move("down")},moveUp:function(){this.ui.move("up")},tags:null};m.CompletionController=o;m.completeCommand=k("complete");m.completeCancelCommand=k("cancel");m.completeDownCommand=k("moveDown");m.completeUpCommand=k("moveUp")});
bespin.tiki.module("completion:ui",function(q,m){function o(i){var f=h.uniqueId("bespin-completion-panel"),d=document.createElement("div");d.id=f;d.className="bespin-completion-panel";d.style.display="none";d.innerHTML='<div class="bespin-completion-pointer"></div><div class="bespin-completion-bubble-outer"><div class="bespin-completion-bubble-inner"><div class="bespin-completion-highlight"></div><ul></ul></div></div>';k(i).append(d);this.panel=k(d);this.parent=k(i)}var k=q("jquery").$,h=q("underscore")._,
e=h.template('<span class="bespin-completion-container"> &mdash; <%= container %></span>'),a=h.template('<div class="bespin-completion-second-row"><%= type %></div>'),b=h.template('<li><div class="bespin-completion-top-row"><span class="bespin-completion-kind bespin-completion-kind-<%= kind %>"><%= kind %></span><span class="bespin-completion-ident"><%= ident %></span><%= container %></div><%= second_row %></li>');o.prototype={_fromBottom:false,_index:0,_tags:null,_getHighlightDimensions:function(i){var f=
i.position(),d=i.outerHeight()-2;i=i.outerWidth()-2;return{left:f.left,top:f.top,height:d,width:i}},_listItemForIndex:function(i){return this.panel.find("li:eq("+i+")")},_populate:function(){var i=h(this._tags).map(function(f){var d=f["class"],g=f.module,j=f.namespace;d=d!=null?d:j!=null?j:"";if(g!=null)d=g+(d!=""?"#"+d:"");g=d==""?"":e({container:d});d=f.type;d=d==null?"":a({type:d});return b({kind:f.kind,ident:f.name,container:g,second_row:d})});this.panel.find("ul").html(i.join("\n"))},panel:null,
visible:false,getCompletion:function(){return this.visible?this._tags[this._index]:null},hide:function(){if(this.visible){this.panel.fadeOut(100);this.visible=false}},move:function(i){var f=this._index,d=this._listItemForIndex(f),g=i==="up"?d.prev():d.next();if(g.length!==0){this._index=f=i==="up"?f-1:f+1;f=k(d).find(".bespin-completion-top-row");var j=k(d).find(".bespin-completion-second-row");d=k(g).find(".bespin-completion-top-row");var n=k(g).find(".bespin-completion-second-row");j.hide();n.show();
var r=this.panel.find(".bespin-completion-highlight");r.stop(true,true);g=this._getHighlightDimensions(g);r.animate(g,100);n.hide();if(i==="down"){i=j.height();d.css("top",i);d.animate({top:0},100)}else{i=n.height();f.css("top",-i);f.animate({top:0},100)}n.fadeIn()}},show:function(i,f,d){this._tags=i=h(i).clone();this._populate();var g=this.visible,j=this.panel;j.stop(true,true);g||j.show();var n=this.parent.offset(),r=n.left,s=r+f.x,w=n.top+f.y;n=j.outerWidth();var v=j.outerHeight(),x=k(window).width(),
l=k(window).height();this._fromBottom=w=w+v+d>l;if(this._index>=i.length)this._index=i.length-1;if(w){w=j.find(".bespin-completion-pointer");w.removeClass("bespin-completion-pointer-up");w.addClass("bespin-completion-pointer-down");j.css({bottom:-f.y,top:""});this._tags.reverse();this._populate();if(!g)this._index=i.length-1}else{w=j.find(".bespin-completion-pointer");w.removeClass("bespin-completion-pointer-down");w.addClass("bespin-completion-pointer-up");j.css({top:f.y+d,bottom:""});if(!g)this._index=
0}if(!g){if(s+f.x+n>x){w.css({left:"",right:32});j.css("left",Math.min(x-n-r,f.x-n+43))}else{w.css({left:32,right:""});j.css("left",Math.max(r,f.x-43))}j.hide().animate({opacity:"show"},100)}i=j.find(".bespin-completion-highlight");i.stop(true,true);f=this._listItemForIndex(this._index);f.find(".bespin-completion-second-row").show();f=this._getHighlightDimensions(f);i.css(f);this.visible=true}};m.CompletionUI=o});bespin.tiki.module("completion:index",function(){});
bespin.tiki.register("::rangeutils",{name:"rangeutils",dependencies:{}});
bespin.tiki.module("rangeutils:utils/range",function(q,m){var o=q("bespin:util/util");m.addPositions=function(k,h){return{row:k.row+h.row,col:k.col+h.col}};m.cloneRange=function(k){var h=k.start;k=k.end;return{start:{row:h.row,col:h.col},end:{row:k.row,col:k.col}}};m.comparePositions=function(k,h){var e=k.row-h.row;return e===0?k.col-h.col:e};m.equal=function(k,h){return m.comparePositions(k.start,h.start)===0&&m.comparePositions(k.end,h.end)===0};m.extendRange=function(k,h){var e=k.end;return{start:k.start,
end:{row:e.row+h.row,col:e.col+h.col}}};m.intersectRangeSets=function(k,h){k=o.clone(k);h=o.clone(h);for(var e=[];k.length>0&&h.length>0;){var a=k.shift(),b=h.shift(),i=m.comparePositions(a.start,b.start),f=m.comparePositions(a.end,b.end);if(m.comparePositions(a.end,b.start)<0){e.push(a);h.unshift(b)}else if(m.comparePositions(b.end,a.start)<0){e.push(b);k.unshift(a)}else if(i<0){e.push({start:a.start,end:b.start});k.unshift({start:b.start,end:a.end});h.unshift(b)}else if(i===0)if(f<0)h.unshift({start:a.end,
end:b.end});else f>0&&k.unshift({start:b.end,end:a.end});else if(i>0){e.push({start:b.start,end:a.start});k.unshift(a);h.unshift({start:a.start,end:b.end})}}return e.concat(k,h)};m.isZeroLength=function(k){return k.start.row===k.end.row&&k.start.col===k.end.col};m.maxPosition=function(k,h){return m.comparePositions(k,h)>0?k:h};m.normalizeRange=function(k){return this.comparePositions(k.start,k.end)<0?k:{start:k.end,end:k.start}};m.rangeSetBoundaries=function(k){return{start:k[0].start,end:k[k.length-
1].end}};m.toString=function(k){var h=k.start;k=k.end;return"[ "+h.row+", "+h.col+" "+k.row+","+ +k.col+" ]"};m.unionRanges=function(k,h){return{start:k.start.row<h.start.row||k.start.row===h.start.row&&k.start.col<h.start.col?k.start:h.start,end:k.end.row>h.end.row||k.end.row===h.end.row&&k.end.col>h.end.col?k.end:h.end}};m.isPosition=function(k){return!o.none(k)&&!o.none(k.row)&&!o.none(k.col)};m.isRange=function(k){return!o.none(k)&&m.isPosition(k.start)&&m.isPosition(k.end)}});
bespin.tiki.module("rangeutils:index",function(){});bespin.tiki.register("::undomanager",{name:"undomanager",dependencies:{}});
bespin.tiki.module("undomanager:index",function(q,m){var o=q("bespin:util/util");q("environment");m.UndoManager=function(){};o.mixin(m.UndoManager.prototype,{_redoStack:[],_undoStack:[],_undoOrRedo:function(k,h,e){if(h.length===0)return false;h=h.pop();if(!h.target[k](h.context)){this._redoStack=[];this._undoStack=[];return false}e.push(h);return true},redo:function(){return this._undoOrRedo("redo",this._redoStack,this._undoStack)},registerUndo:function(k,h){this._redoStack=[];this._undoStack.push({target:k,
context:h})},undo:function(){return this._undoOrRedo("undo",this._undoStack,this._redoStack)}});m.global=new m.UndoManager;m.undoManagerCommand=function(k,h){m.global[h.commandExt.name]()}});bespin.tiki.register("::environment",{name:"environment",dependencies:{settings:"0.0.0"}});
bespin.tiki.module("environment:index",function(q,m){var o=q("bespin:util/util"),k=q("bespin:console").console,h=q("bespin:plugins").catalog,e=q("settings").settings;m.Environment=function(){this.commandLine=null;window.addEventListener("resize",this.dimensionsChanged.bind(this),false)};Object.defineProperties(m.Environment.prototype,{settings:{value:{set:function(a,b){if(o.none(a))throw new Error("setSetting(): key must be supplied");if(o.none(b))throw new Error("setSetting(): value must be supplied");
e.set(a,b)},get:function(a){if(o.none(a))throw new Error("getSetting(): key must be supplied");return e.get(a)}}},dimensionsChanged:{value:function(){h.publish(this,"dimensionsChanged")}},session:{get:function(){return h.getObject("session")}},view:{get:function(){if(!this.session)return null;return this.session.currentView}},editor:{get:function(){if(!this.session)return null;return this.session.currentView.editor}},contexts:{get:function(){if(!this.view)return[];var a=this.view.editor.layoutManager.syntaxManager,
b=this.view.getSelectedRange().start;return a.contextsAtPosition(b)}},buffer:{get:function(){if(this.session)return this.view.editor.buffer;else k.error("command attempted to get buffer but there's no session")}},model:{get:function(){if(this.buffer)return this.view.editor.layoutManager.textStorage;else k.error("Session has no current buffer")}},file:{get:function(){if(this.buffer)return this.buffer.file;else k.error("Session has no current buffer")}},files:{get:function(){return h.getObject("files")}}});
m.env=new m.Environment});bespin.tiki.register("::ctags",{name:"ctags",dependencies:{traits:"0.0.0",underscore:"0.0.0"}});
bespin.tiki.module("ctags:index",function(q,m){var o=q("underscore")._,k=q("./reader").TagReader;q=q("traits").Trait;m.Tags=function(){this.tags=[]};m.Tags.prototype=Object.create(Object.prototype,q.compose(q({_search:function(h,e){var a={name:h};h=this.tags;var b=o(h).sortedIndex(a,function(i){return i.name});for(b=a=b;a>=0&&a<h.length&&e(h[a]);)a--;for(;b>=0&&b<h.length&&e(h[b]);)b++;return h.slice(a+1,b)},add:function(h){var e=this.tags;Array.prototype.push.apply(e,h);e.sort(function(a,b){a=a.name;
b=b.name;if(a<b)return-1;if(a===b)return 0;return 1})},get:function(h){return this._search(h,function(e){return e.name===h})},scan:function(h,e,a){if(a===null||a===undefined)a={};var b=h.split("\n");h=parse(h,e,1);e=new Interpreter(h,e,b,a);e.interpret();this.add(e.tags)},stem:function(h){var e=h.length;return this._search(h,function(a){return a.name.substring(0,e)===h})}}),k))});
bespin.tiki.module("ctags:reader",function(q,m){var o=q("underscore")._;q=q("traits").Trait;m.TagReader=q({readLines:function(k){var h=[];o(k).each(function(e){e=e.split("\t");if(!(e.length<3)){var a=e[0];if(!/^!_TAG_/.test(a)){a={name:a,tagfile:e[1],addr:e[2]};var b;if(e.length>3&&e[3].indexOf(":")===-1){a.kind=e[3];b=4}else b=3;var i={};o(e.slice(b)).each(function(f){f=/^([^:]+):(.*)/.exec(f);i[f[1]]=f[2]});a.fields=i;h.push(a)}}});this.add(h)},readString:function(k){this.readLines(k.split("\n"))}})});
bespin.tiki.register("::theme_manager",{name:"theme_manager",dependencies:{theme_manager_base:"0.0.0",settings:"0.0.0",events:"0.0.0",less:"0.0.0"}});
bespin.tiki.module("theme_manager:index",function(q,m){q("bespin:promise");var o=q("bespin:plugins").catalog;q("events");var k=q("themestyles"),h=q("settings").settings,e=null,a=null;m.themestyles=k;m.themeSettingChanged=function(b,i,f){var d=o.getExtensionByKey("theme",f);if(f==="standard"||!f||!d){d=null;if(a!==null)d=o.getExtensionByKey("theme",a)}if(d)d.load().then(function(g){e&&k.unregisterThemeStyles(e);k.currentThemeVariables=g();e=d;k.parseGlobalVariables();k.reparse();d.url&&k.registerThemeStyles(d);
o.publish(m,"themeChange")});else if(e){k.unregisterThemeStyles(e);e=null;k.currentThemeVariables=null;k.parseGlobalVariables();k.reparse();o.publish(this,"themeChange")}};o.registerExtension("settingChange",{match:"theme",pointer:m.themeSettingChanged.bind(m)});m.setStandardTheme=function(b){a=b;b!==h.get("theme")&&m.themeSettingChanged(this)};m.setBasePlugin=function(b){k.basePluginName=b};m.startParsing=function(){k.preventParsing=false;return k.reparse()};m.registerTheme=function(b){var i=h.get("theme");
b.name===i&&m.themeSettingChanged(this,"theme",b.name)};m.unregisterTheme=function(b){b.name===h.get("theme")&&m.themeSettingChanged(this)};m.appLaunched=function(){o.publish(m,"themeChange")}});
bespin.tiki.module("theme_manager:themestyles",function(q,m){var o=q("bespin:util/util"),k=q("bespin:plugins").catalog,h=q("bespin:console").console,e=q("bespin:promise").Promise,a=q("bespin:promise").group,b=q("bespin:proxy"),i=new (q("less").Parser)({optimization:3}),f=1;m.currentThemeVariables=null;m.basePluginName=null;m.preventParsing=true;var d="";m.globalThemeVariables={};var g={},j={},n=function(p){var t={},u=[],A=function(E,B){u.push(E);if(typeof B!="object")t[u.join("_")]=B;else for(prop in B)A(prop,
B[prop]);u.pop()};A("global",p);return t},r={},s={font:"arial, lucida, helvetica, sans-serif",font_size:"14px",line_height:"1.8em",color:"#DAD4BA",text_shadow:"1px 1px rgba(0, 0, 0, 0.4)",error_color:"#F99",header_color:"white",link_color:"#ACF",control:{color:"#E1B41F",border:"1px solid rgba(0, 0, 0, 0.2)",border_radius:"0.25em",background:"rgba(0, 0, 0, 0.2)",active:{color:"#FF9600",border:"1px solid #E1B41F",inset_color:"#ff9600",background:"rgba(0, 0, 0, 0.2)"}},pane:{h1:{font:"'MuseoSans', Helvetica",
font_size:"2.8em",color:"white"},color:"#DAD4BA",text_shadow:"1px 1px rgba(0, 0, 0, 0.4)",link_color:"white",background:"#45443C",border_radius:".5em"},form:{color:"white",text_shadow:"1px 1px rgba(0, 0, 0, 0.4)",font:"'Lucida Sans','Lucida Grande',Verdana,Arial,sans-serif",font_size:"@global_font_size",line_height:"@global_line_height"},button:{color:"white",background:"#3E6CB9"},container:{background:"#1E1916",border:"1px solid black"},selectable:{color:"white",border:"0px solid transparent",background:"transparent",
active:{color:"black",border:"0px solid transparent",background:"#FF8E00"},hover:{color:"black",border:"0px solid transparent",background:"#FF8E00"}},hint:{color:"#AAA",active:{color:"black"},hover:{color:"black"}},accelerator:{color:"#996633",active:{color:"black"},hover:{color:"black"}},menu:{border_color:"black",inset_color_right:"#1E1916",inset_color_top_left:"#3E3936",background:"transparent"}};s=n(s);m.getPluginThemeVariables=function(p){var t=k.plugins[p];if(!t)return null;var u={};if(m.currentThemeVariables&&
m.currentThemeVariables[p])u=m.currentThemeVariables[p];t.provides.forEach(function(A){if(A.ep==="themevariable"){var E=A.name;u[E]=u[E]||A.defaultValue}});return u};m.parseGlobalVariables=function(){var p={},t="",u=m.currentThemeVariables;o.mixin(p,s);u&&u.global&&o.mixin(p,n(u.global));m.globalThemeVariables=p;for(prop in p)t+="@"+prop+":"+p[prop]+";";d=t};m.parseGlobalVariables();var w=function(p,t,u){if(g[t])styleElem=document.getElementById("_bespin_theme_style_"+g[t]);else{styleElem=document.createElement("style");
styleElem.setAttribute("id","_bespin_theme_style_"+f);g[t]=f;f++;document.body.appendChild(styleElem)}i.parse(d+u+j[t],function(A,E){if(A){A="Error less parsing "+t+" "+A.message;h.error(A);p.reject(A)}else{try{var B=E.toCSS()}catch(G){A="Error less parsing "+t+" "+G;h.error(A);p.reject(A);return}if(styleElem&&styleElem.firstChild)styleElem.firstChild.textContent=B;else{A=document.createTextNode(B);styleElem.appendChild(A)}p.resolve()}})},v={};m.parsePlugin=function(p){if(m.preventParsing)return(new e).resolve();
var t=k.plugins[p];if(!t)throw"reparsePlugin: plugin "+p+" is not defined!";if(!v[p]){v[p]=new e;setTimeout(function(){var u=m.getPluginThemeVariables(p),A="";for(prop in u)A+="@"+prop+":"+u[prop]+";";u=new e;u.then(function(E){v[this.name].resolve(E);v[this.name]=null}.bind(this),function(){v[this.name].reject(data);v[this.name]=null}.bind(this));w(u,p,A)}.bind(t),0)}return v[p]};var x=function(p,t,u,A){u=u.replace(/url\(['"]*([^'")]*)(['"]*)\)/g,"url("+p+"$1)");j[t]+=u;A&&A.resolve()},l=null;m.registerThemeStyles=
function(p){var t=p.getPluginName(),u=k.getResourceURL(t);if(!(p.url instanceof Array))p.url=[p.url];j[t]="";var A=[],E=m.preventParsing;p.url.forEach(function(B){if(r[t]&&r[t][B])x(u,t,r[t][B]);else{var G=new e;A.push(G);var I=u+B+"?"+(new Date).getTime();b.xhr("GET",I,true,function(J){J.overrideMimeType("text/plain")}).then(function(J){x(u,t,J,G)},function(){h.error("registerLessFile: Could not load "+u+B);G.resolve()})}});if(A.length===0)m.parsePlugin(t);else{E||a(A).then(function(){m.parsePlugin(t)});
if(l!==null)A=A.concat(l);l=a(A)}};m.reparse=function(){var p=new e;if(m.preventParsing)return p.resolve();l?l.then(function(){var t=[],u=m.basePluginName;u!==null&&j[u]&&t.push(m.parsePlugin(u));for(var A in j)A!==u&&t.push(m.parsePlugin(A));a(t).then(p.resolve.bind(p),p.reject.bind(p))},function(t){p.reject(t)}):p.resolve();return p};m.unregisterThemeStyles=function(p){p=p.getPluginName();if(g[p]){var t=document.getElementById("_bespin_theme_style_"+g[p]);t.parentNode.removeChild(t);delete g[p];
delete j[p]}}});bespin.tiki.register("::types",{name:"types",dependencies:{}});
bespin.tiki.module("types:basic",function(q,m){var o=q("bespin:plugins").catalog,k=q("bespin:console").console,h=q("bespin:promise").Promise;m.text={isValid:function(e){return typeof e=="string"},toString:function(e){return e},fromString:function(e){return e}};m.number={isValid:function(e){if(isNaN(e))return false;if(e===null)return false;if(e===undefined)return false;if(e===Infinity)return false;return typeof e=="number"},toString:function(e){if(!e)return null;return""+e},fromString:function(e){if(!e)return null;
var a=parseInt(e,10);if(isNaN(a))throw new Error("Can't convert \""+e+'" to a number.');return a}};m.bool={isValid:function(e){return typeof e=="boolean"},toString:function(e){return""+e},fromString:function(e){if(e===null)return null;if(!e.toLowerCase)return!!e;var a=e.toLowerCase();if(a=="true")return true;else if(a=="false")return false;return!!e}};m.object={isValid:function(e){return typeof e=="object"},toString:function(e){return JSON.stringify(e)},fromString:function(e){return JSON.parse(e)}};
m.selection={isValid:function(e,a){if(typeof e!="string")return false;if(!a.data){k.error("Missing data on selection type extension. Skipping");return true}var b=false;a.data.forEach(function(i){if(e==i)b=true});return b},toString:function(e){return e},fromString:function(e){return e},resolveTypeSpec:function(e,a){var b=new h;if(a.data){e.data=a.data;b.resolve()}else if(a.pointer)o.loadObjectForPropertyPath(a.pointer).then(function(i){i=i(a);if(typeof i.then==="function")i.then(function(f){e.data=
f;b.resolve()});else{e.data=i;b.resolve()}},function(i){b.reject(i)});else{k.warn("Missing data/pointer for selection",a);b.resolve()}return b}}});
bespin.tiki.module("types:types",function(q,m){function o(a){var b=new e,i=h.getExtensionByKey("type",a.name);i?b.resolve({ext:i,typeSpec:a}):b.reject(new Error("Unknown type: "+a.name));return b}function k(a){if(typeof a==="string")return o({name:a});if(typeof a==="object")if(a.name==="deferred"){var b=new e;m.undeferTypeSpec(a).then(function(i){k(i).then(function(f){b.resolve(f)},function(f){b.reject(f)})});return b}else return o(a);throw new Error("Unknown typeSpec type: "+typeof a);}var h=q("bespin:plugins").catalog;
q("bespin:console");var e=q("bespin:promise").Promise;m.getSimpleName=function(a){if(!a)throw new Error("null|undefined is not a valid typeSpec");if(typeof a=="string")return a;if(typeof a=="object"){if(!a.name)throw new Error("Missing name member to typeSpec");return a.name}throw new Error("Not a typeSpec: "+a);};m.equals=function(a,b){return m.getSimpleName(a)==m.getSimpleName(b)};m.undeferTypeSpec=function(a){var b=new e;if(!a.pointer){b.reject(new Error("Missing deferred pointer"));return b}h.loadObjectForPropertyPath(a.pointer).then(function(i){i=
i(a);typeof i.then==="function"?i.then(function(f){b.resolve(f)},function(f){b.reject(f)}):b.resolve(i)},function(i){b.reject(i)});return b};m.resolveType=function(a){var b=new e;k(a).then(function(i){i.ext.load(function(f){typeof f.resolveTypeSpec==="function"?f.resolveTypeSpec(i.ext,i.typeSpec).then(function(){b.resolve({type:f,ext:i.ext})},function(d){b.reject(d)}):b.resolve({type:f,ext:i.ext})})},function(i){b.reject(i)});return b};m.fromString=function(a,b){var i=new e;m.resolveType(b).then(function(f){i.resolve(f.type.fromString(a,
f.ext))});return i};m.toString=function(a,b){var i=new e;m.resolveType(b).then(function(f){i.resolve(f.type.toString(a,f.ext))});return i};m.isValid=function(a,b){var i=new e;m.resolveType(b).then(function(f){i.resolve(f.type.isValid(a,f.ext))});return i}});bespin.tiki.module("types:index",function(){});bespin.tiki.register("::jquery",{name:"jquery",dependencies:{}});bespin.tiki.module("jquery:index",function(q,m){m.$=window.$});
bespin.tiki.register("::embedded",{name:"embedded",dependencies:{theme_manager:"0.0.0",text_editor:"0.0.0",appconfig:"0.0.0",edit_session:"0.0.0",screen_theme:"0.0.0"}});bespin.tiki.module("embedded:index",function(){});bespin.tiki.register("::settings",{name:"settings",dependencies:{types:"0.0.0"}});
bespin.tiki.module("settings:commands",function(q,m){q("bespin:plugins");q("environment");var o=q("settings").settings;m.setCommand=function(k,h){var e;if(k.setting)if(k.value===undefined)e="<strong>"+k.setting+"</strong> = "+o.get(k.setting);else{e="Setting: <strong>"+k.setting+"</strong> = "+k.value;o.set(k.setting,k.value)}else{k=o._list();e="";k.sort(function(a,b){return a.key<b.key?-1:a.key==b.key?0:1});k.forEach(function(a){e+='<a class="setting" href="https://wiki.mozilla.org/Labs/Bespin/Settings#'+
a.key+'" title="View external documentation on setting: '+a.key+'" target="_blank">'+a.key+"</a> = "+a.value+"<br/>"})}h.done(e)};m.unsetCommand=function(k,h){o.resetValue(k.setting);h.done("Reset "+k.setting+" to default: "+o.get(k.setting))}});
bespin.tiki.module("settings:cookie",function(q,m){var o=q("bespin:util/cookie");m.CookiePersister=function(){};m.CookiePersister.prototype={loadInitialValues:function(k){k._loadDefaultValues().then(function(){var h=o.get("settings");k._loadFromObject(JSON.parse(h))}.bind(this))},persistValue:function(k){try{var h={};k._getSettingNames().forEach(function(b){h[b]=k.get(b)});var e=JSON.stringify(h);o.set("settings",e)}catch(a){console.error("Unable to JSONify the settings! "+a)}}}});
bespin.tiki.module("settings:index",function(q,m){var o=q("bespin:plugins").catalog,k=q("bespin:console").console,h=q("bespin:promise").Promise,e=q("bespin:promise").group,a=q("types:types");m.addSetting=function(b){q("settings").settings.addSetting(b)};m.getSettings=function(){return o.getExtensions("setting")};m.getTypeSpecFromAssignment=function(b){var i=b.assignments;b="text";if(i){var f=null;i.forEach(function(d){if(d.param.name==="setting")f=d});if(f)if((i=f.value)&&i!=="")if(i=o.getExtensionByKey("setting",
i))b=i.type}return b};m.MemorySettings=function(){};m.MemorySettings.prototype={_values:{},_deactivated:{},setPersister:function(b){(this._persister=b)&&b.loadInitialValues(this)},get:function(b){return this._values[b]},set:function(b,i){var f=o.getExtensionByKey("setting",b);if(f)if(typeof i=="string"&&f.type=="string")this._values[b]=i;else{var d=false;a.fromString(i,f.type).then(function(g){d=true;this._values[b]=g;o.publish(this,"settingChange",b,g)}.bind(this),function(g){k.error("Error setting",
b,": ",g)});if(!d){k.warn("About to set string version of ",b,"delaying typed set.");this._values[b]=i}}else{k.warn("Setting not defined: ",b,i);this._deactivated[b]=i}this._persistValue(b,i);return this},addSetting:function(b){if(b.name){!b.defaultValue===undefined&&k.error("Setting.defaultValue == undefined",b);a.isValid(b.defaultValue,b.type).then(function(i){i||k.warn("!Setting.isValid(Setting.defaultValue)",b);this.set(b.name,this._deactivated[b.name]||b.defaultValue)}.bind(this),function(i){k.error("Type error ",
i," ignoring setting ",b)})}else k.error("Setting.name == undefined. Ignoring.",b)},resetValue:function(b){var i=o.getExtensionByKey("setting",b);i?this.set(b,i.defaultValue):k.log("ignore resetValue on ",b)},resetAll:function(){this._getSettingNames().forEach(function(b){this.resetValue(b)}.bind(this))},_getSettingNames:function(){var b=[];o.getExtensions("setting").forEach(function(i){b.push(i.name)});return b},_list:function(){var b=[];this._getSettingNames().forEach(function(i){b.push({key:i,
value:this.get(i)})}.bind(this));return b},_persistValue:function(b,i){var f=this._persister;f&&f.persistValue(this,b,i)},_loadInitialValues:function(){var b=this._persister;b?b.loadInitialValues(this):this._loadDefaultValues()},_loadDefaultValues:function(){return this._loadFromObject(this._defaultValues())},_loadFromObject:function(b){var i=[],f=function(r){return function(s){this.set(r,s)}};for(var d in b)if(b.hasOwnProperty(d)){var g=b[d],j=o.getExtensionByKey("setting",d);if(j){g=a.fromString(g,
j.type);j=f(d);g.then(j);i.push(g)}}var n=new h;e(i).then(function(){n.resolve()});return n},_saveToObject:function(){var b=[],i={};this._getSettingNames().forEach(function(d){var g=this.get(d),j=o.getExtensionByKey("setting",d);if(j){g=a.toString(g,j.type);g.then(function(n){i[d]=n});b.push(g)}}.bind(this));var f=new h;e(b).then(function(){f.resolve(i)});return f},_defaultValues:function(){var b={};o.getExtensions("setting").forEach(function(i){b[i.name]=i.defaultValue});return b}};m.settings=new m.MemorySettings});
bespin.tiki.register("::appconfig",{name:"appconfig",dependencies:{jquery:"0.0.0",canon:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("appconfig:index",function(q,m){var o=q("jquery").$,k=q("settings").settings,h=q("bespin:promise").group,e=q("bespin:promise").Promise,a=q("bespin:console").console,b=q("bespin:util/stacktrace").Trace,i=q("bespin:util/util"),f=true;m.launch=function(j){var n=new e;o("#_bespin_loading").remove();var r;if(f){r=bespin.tiki.require;f=false}else r=(new (bespin.tiki.require("bespin:sandbox").Sandbox)).createRequire({id:"index",ownerPackage:bespin.tiki.loader.anonymousPackage});var s=
r("bespin:plugins").catalog;j=j||{};m.normalizeConfig(s,j);var w=j.objects;for(var v in w)s.registerObject(v,w[v]);for(var x in j.settings)k.set(x,j.settings[x]);var l=function(){var t=r("environment").env,u=t.editor;if(u){j.lineNumber&&u.setLineNumber(j.lineNumber);if(j.stealFocus)u.focus=true;if(j.readOnly)u.readOnly=j.readOnly;if(j.syntax)u.syntax=j.syntax}if(u=s.getObject("commandLine"))t.commandLine=u;s.publish(this,"appLaunched");n.resolve(t)}.bind(this),p=new e;p.then(function(){w.loginController?
s.createObject("loginController").then(function(t){t.showLogin().then(function(u){j.objects.session.arguments.push(u);m.launchEditor(s,j).then(l,n.reject.bind(n))})}):m.launchEditor(s,j).then(l,n.reject.bind(n))},function(t){n.reject(t)});s.plugins.theme_manager?bespin.tiki.require.ensurePackage("::theme_manager",function(){var t=r("theme_manager");j.theme.basePlugin&&t.setBasePlugin(j.theme.basePlugin);j.theme.standard&&t.setStandardTheme(j.theme.standard);t.startParsing().then(function(){p.resolve()},
function(u){p.reject(u)})}):p.resolve();return n};m.normalizeConfig=function(j,n){if(n.objects===undefined)n.objects={};if(n.autoload===undefined)n.autoload=[];if(n.theme===undefined)n.theme={};if(!n.theme.basePlugin&&j.plugins.screen_theme)n.theme.basePlugin="screen_theme";if(!n.initialContent)n.initialContent="";if(!n.settings)n.settings={};if(!n.objects.notifier&&j.plugins.notifier)n.objects.notifier={};if(!n.objects.loginController&&j.plugins.userident)n.objects.loginController={};if(!n.objects.fileHistory&&
j.plugins.file_history)n.objects.fileHistory={factory:"file_history",arguments:["session"],objects:{"0":"session"}};if(!n.objects.server&&j.plugins.bespin_server){n.objects.server={factory:"bespin_server"};n.objects.filesource={factory:"bespin_filesource",arguments:["server"],objects:{"0":"server"}}}if(!n.objects.files&&j.plugins.filesystem&&n.objects.filesource)n.objects.files={arguments:["filesource"],objects:{"0":"filesource"}};if(!n.objects.editor)n.objects.editor={factory:"text_editor",arguments:[n.initialContent]};
if(!n.objects.session)n.objects.session={arguments:["editor"],objects:{"0":"editor"}};if(!n.objects.commandLine&&j.plugins.command_line)n.objects.commandLine={};if(n.gui===undefined)n.gui={};j={};for(var r in n.gui){var s=n.gui[r];if(s.component)j[s.component]=true}if(!n.gui.center&&n.objects.editor&&!j.editor)n.gui.center={component:"editor"};if(!n.gui.south&&n.objects.commandLine&&!j.commandLine)n.gui.south={component:"commandLine"}};m.launchEditor=function(j,n){var r=new e;if(n===null){a.error("Cannot start editor without a configuration!");
r.reject("Cannot start editor without a configuration!");return r}d(j,n).then(function(){g(j,n,r)},function(s){a.error("Error while creating objects");(new b(s)).log();r.reject(s)});return r};var d=function(j,n){var r=[];for(var s in n.objects)r.push(j.createObject(s));return h(r)},g=function(j,n,r){var s=document.createElement("div");s.setAttribute("class","container");var w=document.createElement("div");w.setAttribute("class","center-container");s.appendChild(w);var v=n.element||document.body;i.addClass(v,
"bespin");v.appendChild(s);for(var x in n.gui){var l=n.gui[x],p=j.getObject(l.component);if(!p){j="Cannot find object "+l.component+" to attach to the Bespin UI";a.error(j);r.reject(j);return}v=p.element;if(!v){j="Component "+l.component+' does not have an "element" attribute to attach to the Bespin UI';a.error(j);r.reject(j);return}o(v).addClass(x);x=="west"||x=="east"||x=="center"?w.appendChild(v):s.appendChild(v);p.elementAppended&&p.elementAppended()}r.resolve()}});
bespin.tiki.register("::events",{name:"events",dependencies:{traits:"0.0.0"}});bespin.tiki.module("events:index",function(q,m){m.Event=function(){var o=[],k=function(){var h=arguments;o.forEach(function(e){e.func.apply(null,h)})};k.add=function(){arguments.length==1?o.push({ref:arguments[0],func:arguments[0]}):o.push({ref:arguments[0],func:arguments[1]})};k.remove=function(h){o=o.filter(function(e){return h!==e.ref})};k.removeAll=function(){o=[]};return k}});
bespin.tiki.register("::screen_theme",{name:"screen_theme",dependencies:{theme_manager:"0.0.0"}});bespin.tiki.module("screen_theme:index",function(){});
(function(){var q=bespin.tiki.require("jquery").$;q(document).ready(function(){bespin.tiki.require("bespin:plugins").catalog.registerMetadata({text_editor:{resourceURL:"resources/text_editor/",description:"Canvas-based text editor component and many common editing commands",dependencies:{completion:"0.0.0",undomanager:"0.0.0",settings:"0.0.0",canon:"0.0.0",rangeutils:"0.0.0",traits:"0.0.0",theme_manager:"0.0.0",keyboard:"0.0.0",edit_session:"0.0.0",syntax_manager:"0.0.0"},testmodules:["tests/controllers/testLayoutmanager",
"tests/models/testTextstorage","tests/testScratchcanvas","tests/utils/testRect"],provides:[{action:"new",pointer:"views/editor#EditorView",ep:"factory",name:"text_editor"},{pointer:"views/editor#EditorView",ep:"appcomponent",name:"editor_view"},{predicates:{isTextView:true},pointer:"commands/editing#backspace",ep:"command",key:"backspace",name:"backspace"},{predicates:{isTextView:true},pointer:"commands/editing#deleteCommand",ep:"command",key:"delete",name:"delete"},{description:"Delete all lines currently selected",
key:"ctrl_d",predicates:{isTextView:true},pointer:"commands/editing#deleteLines",ep:"command",name:"deletelines"},{description:"Create a new, empty line below the current one",key:"ctrl_return",predicates:{isTextView:true},pointer:"commands/editing#openLine",ep:"command",name:"openline"},{description:"Join the current line with the following",key:"ctrl_shift_j",predicates:{isTextView:true},pointer:"commands/editing#joinLines",ep:"command",name:"joinline"},{params:[{defaultValue:"",type:"text",name:"text",
description:"The text to insert"}],pointer:"commands/editing#insertText",ep:"command",name:"insertText"},{predicates:{completing:false,isTextView:true},pointer:"commands/editing#newline",ep:"command",key:"return",name:"newline"},{predicates:{completing:false,isTextView:true},pointer:"commands/editing#tab",ep:"command",key:"tab",name:"tab"},{predicates:{isTextView:true},pointer:"commands/editing#untab",ep:"command",key:"shift_tab",name:"untab"},{predicates:{isTextView:true},ep:"command",name:"move"},
{description:"Repeat the last search (forward)",pointer:"commands/editor#findNextCommand",ep:"command",key:"ctrl_g",name:"findnext"},{description:"Repeat the last search (backward)",pointer:"commands/editor#findPrevCommand",ep:"command",key:"ctrl_shift_g",name:"findprev"},{predicates:{completing:false,isTextView:true},pointer:"commands/movement#moveDown",ep:"command",key:"down",name:"move down"},{predicates:{isTextView:true},pointer:"commands/movement#moveLeft",ep:"command",key:"left",name:"move left"},
{predicates:{isTextView:true},pointer:"commands/movement#moveRight",ep:"command",key:"right",name:"move right"},{predicates:{completing:false,isTextView:true},pointer:"commands/movement#moveUp",ep:"command",key:"up",name:"move up"},{predicates:{isTextView:true},ep:"command",name:"select"},{predicates:{isTextView:true},pointer:"commands/movement#selectDown",ep:"command",key:"shift_down",name:"select down"},{predicates:{isTextView:true},pointer:"commands/movement#selectLeft",ep:"command",key:"shift_left",
name:"select left"},{predicates:{isTextView:true},pointer:"commands/movement#selectRight",ep:"command",key:"shift_right",name:"select right"},{predicates:{isTextView:true},pointer:"commands/movement#selectUp",ep:"command",key:"shift_up",name:"select up"},{predicates:{isTextView:true},pointer:"commands/movement#moveLineEnd",ep:"command",key:["end","ctrl_right"],name:"move lineend"},{predicates:{isTextView:true},pointer:"commands/movement#selectLineEnd",ep:"command",key:["shift_end","ctrl_shift_right"],
name:"select lineend"},{predicates:{isTextView:true},pointer:"commands/movement#moveDocEnd",ep:"command",key:"ctrl_down",name:"move docend"},{predicates:{isTextView:true},pointer:"commands/movement#selectDocEnd",ep:"command",key:"ctrl_shift_down",name:"select docend"},{predicates:{isTextView:true},pointer:"commands/movement#moveLineStart",ep:"command",key:["home","ctrl_left"],name:"move linestart"},{predicates:{isTextView:true},pointer:"commands/movement#selectLineStart",ep:"command",key:["shift_home",
"ctrl_shift_left"],name:"select linestart"},{predicates:{isTextView:true},pointer:"commands/movement#moveDocStart",ep:"command",key:"ctrl_up",name:"move docstart"},{predicates:{isTextView:true},pointer:"commands/movement#selectDocStart",ep:"command",key:"ctrl_shift_up",name:"select docstart"},{predicates:{isTextView:true},pointer:"commands/movement#moveNextWord",ep:"command",key:["alt_right"],name:"move nextword"},{predicates:{isTextView:true},pointer:"commands/movement#selectNextWord",ep:"command",
key:["alt_shift_right"],name:"select nextword"},{predicates:{isTextView:true},pointer:"commands/movement#movePreviousWord",ep:"command",key:["alt_left"],name:"move prevword"},{predicates:{isTextView:true},pointer:"commands/movement#selectPreviousWord",ep:"command",key:["alt_shift_left"],name:"select prevword"},{predicates:{isTextView:true},pointer:"commands/movement#selectAll",ep:"command",key:["ctrl_a","meta_a"],name:"select all"},{predicates:{isTextView:true},ep:"command",name:"scroll"},{predicates:{isTextView:true},
pointer:"commands/scrolling#scrollDocStart",ep:"command",key:"ctrl_home",name:"scroll start"},{predicates:{isTextView:true},pointer:"commands/scrolling#scrollDocEnd",ep:"command",key:"ctrl_end",name:"scroll end"},{predicates:{isTextView:true},pointer:"commands/scrolling#scrollPageDown",ep:"command",key:"pagedown",name:"scroll down"},{predicates:{isTextView:true},pointer:"commands/scrolling#scrollPageUp",ep:"command",key:"pageup",name:"scroll up"},{pointer:"commands/editor#lcCommand",description:"Change all selected text to lowercase",
withKey:"CMD SHIFT L",ep:"command",name:"lc"},{pointer:"commands/editor#detabCommand",description:"Convert tabs to spaces.",params:[{defaultValue:null,type:"text",name:"tabsize",description:"Optionally, specify a tab size. (Defaults to setting.)"}],ep:"command",name:"detab"},{pointer:"commands/editor#entabCommand",description:"Convert spaces to tabs.",params:[{defaultValue:null,type:"text",name:"tabsize",description:"Optionally, specify a tab size. (Defaults to setting.)"}],ep:"command",name:"entab"},
{pointer:"commands/editor#trimCommand",description:"trim trailing or leading whitespace from each line in selection",params:[{defaultValue:"both",type:{data:[{name:"left"},{name:"right"},{name:"both"}],name:"selection"},name:"side",description:"Do we trim from the left, right or both"}],ep:"command",name:"trim"},{pointer:"commands/editor#ucCommand",description:"Change all selected text to uppercase",withKey:"CMD SHIFT U",ep:"command",name:"uc"},{predicates:{isTextView:true},pointer:"controllers/undo#undoManagerCommand",
ep:"command",key:["ctrl_shift_z"],name:"redo"},{predicates:{isTextView:true},pointer:"controllers/undo#undoManagerCommand",ep:"command",key:["ctrl_z"],name:"undo"},{description:"The distance in characters between each tab",defaultValue:8,type:"number",ep:"setting",name:"tabstop"},{description:"Customize the keymapping",defaultValue:"{}",type:"text",ep:"setting",name:"customKeymapping"},{description:"The keymapping to use",defaultValue:"standard",type:"text",ep:"setting",name:"keymapping"},{description:"The editor font size in pixels",
defaultValue:14,type:"number",ep:"setting",name:"fontsize"},{description:"The editor font face",defaultValue:"Monaco, Lucida Console, monospace",type:"text",ep:"setting",name:"fontface"},{defaultValue:{color:"#e5c138",paddingLeft:5,backgroundColor:"#4c4a41",paddingRight:10},ep:"themevariable",name:"gutter"},{defaultValue:{color:"#e6e6e6",selectedTextBackgroundColor:"#526da5",backgroundColor:"#2a211c",cursorColor:"#879aff",unfocusedCursorBackgroundColor:"#73171e",unfocusedCursorColor:"#ff0033"},ep:"themevariable",
name:"editor"},{defaultValue:{comment:"#666666",directive:"#999999",keyword:"#42A8ED",plain:"#e6e6e6",error:"#ff0000",operator:"#88BBFF",identifier:"#D841FF",string:"#039A0A"},ep:"themevariable",name:"highlighter"},{defaultValue:{nibStrokeStyle:"rgb(150, 150, 150)",fullAlpha:1,barFillStyle:"rgb(0, 0, 0)",particalAlpha:0.3,barFillGradientBottomStop:"rgb(44, 44, 44)",backgroundStyle:"#2A211C",thickness:17,padding:5,trackStrokeStyle:"rgb(150, 150, 150)",nibArrowStyle:"rgb(255, 255, 255)",barFillGradientBottomStart:"rgb(22, 22, 22)",
barFillGradientTopStop:"rgb(40, 40, 40)",barFillGradientTopStart:"rgb(90, 90, 90)",nibStyle:"rgb(100, 100, 100)",trackFillStyle:"rgba(50, 50, 50, 0.8)"},ep:"themevariable",name:"scroller"},{description:"Event: Notify when something within the editor changed.",params:[{required:true,name:"pointer",description:"Function that is called whenever a change happened."}],ep:"extensionpoint",name:"editorChange"}],type:"plugins/supported",name:"text_editor"},less:{resourceURL:"resources/less/",description:"Leaner CSS",
contributors:[],author:"Alexis Sellier <self@cloudhead.net>",url:"http://lesscss.org",version:"1.0.11",dependencies:{},testmodules:[],provides:[],keywords:["css","parser","lesscss","browser"],type:"plugins/thirdparty",name:"less"},theme_manager_base:{resourceURL:"resources/theme_manager_base/",name:"theme_manager_base",share:true,environments:{main:true},dependencies:{},testmodules:[],provides:[{description:"(Less)files holding the CSS style information for the UI.",params:[{required:true,name:"url",
description:"Name of the ThemeStylesFile - can also be an array of files."}],ep:"extensionpoint",name:"themestyles"},{description:"Event: Notify when the theme(styles) changed.",params:[{required:true,name:"pointer",description:"Function that is called whenever the theme is changed."}],ep:"extensionpoint",name:"themeChange"},{indexOn:"name",description:"A theme is a way change the look of the application.",params:[{required:false,name:"url",description:"Name of a ThemeStylesFile that holds theme specific CSS rules - can also be an array of files."},
{required:true,name:"pointer",description:"Function that returns the ThemeData"}],ep:"extensionpoint",name:"theme"}],type:"plugins/supported",description:"Defines extension points required for theming"},canon:{resourceURL:"resources/canon/",name:"canon",environments:{main:true,worker:false},dependencies:{environment:"0.0.0",events:"0.0.0",settings:"0.0.0"},testmodules:[],provides:[{indexOn:"name",description:"A command is a bit of functionality with optional typed arguments which can do something small like moving the cursor around the screen, or large like cloning a project from VCS.",
ep:"extensionpoint",name:"command"},{description:"An extension point to be called whenever a new command begins output.",ep:"extensionpoint",name:"addedRequestOutput"},{description:"A dimensionsChanged is a way to be notified of changes to the dimension of Bespin",ep:"extensionpoint",name:"dimensionsChanged"},{description:"How many typed commands do we recall for reference?",defaultValue:50,type:"number",ep:"setting",name:"historyLength"},{action:"create",pointer:"history#InMemoryHistory",ep:"factory",
name:"history"}],type:"plugins/supported",description:"Manages commands"},traits:{resourceURL:"resources/traits/",description:"Traits library, traitsjs.org",dependencies:{},testmodules:[],provides:[],type:"plugins/thirdparty",name:"traits"},keyboard:{resourceURL:"resources/keyboard/",description:"Keyboard shortcuts",dependencies:{canon:"0.0",settings:"0.0"},testmodules:["tests/testKeyboard"],provides:[{description:"A keymapping defines how keystrokes are interpreted.",params:[{required:true,name:"states",
description:"Holds the states and all the informations about the keymapping. See docs: pluginguide/keymapping"}],ep:"extensionpoint",name:"keymapping"}],type:"plugins/supported",name:"keyboard"},worker_manager:{resourceURL:"resources/worker_manager/",description:"Manages a web worker on the browser side",dependencies:{canon:"0.0.0",events:"0.0.0",underscore:"0.0.0"},testmodules:[],provides:[{description:"Low-level web worker control (for plugin development)",ep:"command",name:"worker"},{description:"Restarts all web workers (for plugin development)",
pointer:"#workerRestartCommand",ep:"command",name:"worker restart"}],type:"plugins/supported",name:"worker_manager"},edit_session:{resourceURL:"resources/edit_session/",description:"Ties together the files being edited with the views on screen",dependencies:{events:"0.0.0"},testmodules:["tests/testSession"],provides:[{action:"call",pointer:"#createSession",ep:"factory",name:"session"}],type:"plugins/supported",name:"edit_session"},syntax_manager:{resourceURL:"resources/syntax_manager/",name:"syntax_manager",
environments:{main:true,worker:false},dependencies:{worker_manager:"0.0.0",events:"0.0.0",underscore:"0.0.0",syntax_directory:"0.0.0"},testmodules:[],provides:[],type:"plugins/supported",description:"Provides syntax highlighting services for the editor"},completion:{resourceURL:"resources/completion/",description:"Code completion support",dependencies:{jquery:"0.0.0",ctags:"0.0.0",rangeutils:"0.0.0",canon:"0.0.0",underscore:"0.0.0"},testmodules:[],provides:[{indexOn:"name",description:"Code completion support for specific languages",
ep:"extensionpoint",name:"completion"},{description:"Accept the chosen completion",key:["return","tab"],predicates:{completing:true},pointer:"controller#completeCommand",ep:"command",name:"complete"},{description:"Abandon the completion",key:"escape",predicates:{completing:true},pointer:"controller#completeCancelCommand",ep:"command",name:"complete cancel"},{description:"Choose the completion below",key:"down",predicates:{completing:true},pointer:"controller#completeDownCommand",ep:"command",name:"complete down"},
{description:"Choose the completion above",key:"up",predicates:{completing:true},pointer:"controller#completeUpCommand",ep:"command",name:"complete up"}],type:"plugins/supported",name:"completion"},environment:{testmodules:[],dependencies:{settings:"0.0.0"},resourceURL:"resources/environment/",name:"environment",type:"plugins/supported"},undomanager:{resourceURL:"resources/undomanager/",description:"Manages undoable events",testmodules:["tests/testUndomanager"],provides:[{pointer:"#undoManagerCommand",
ep:"command",key:["ctrl_shift_z"],name:"redo"},{pointer:"#undoManagerCommand",ep:"command",key:["ctrl_z"],name:"undo"}],type:"plugins/supported",name:"undomanager"},rangeutils:{testmodules:["tests/test"],type:"plugins/supported",resourceURL:"resources/rangeutils/",description:"Utility functions for dealing with ranges of text",name:"rangeutils"},stylesheet:{resourceURL:"resources/stylesheet/",name:"stylesheet",environments:{worker:true},dependencies:{standard_syntax:"0.0.0"},testmodules:[],provides:[{pointer:"#CSSSyntax",
ep:"syntax",fileexts:["css","less"],name:"css"}],type:"plugins/supported",description:"CSS syntax highlighter"},html:{resourceURL:"resources/html/",name:"html",environments:{worker:true},dependencies:{standard_syntax:"0.0.0"},testmodules:[],provides:[{pointer:"#HTMLSyntax",ep:"syntax",fileexts:["htm","html"],name:"html"}],type:"plugins/supported",description:"HTML syntax highlighter"},js_syntax:{resourceURL:"resources/js_syntax/",name:"js_syntax",environments:{worker:true},dependencies:{standard_syntax:"0.0.0"},
testmodules:[],provides:[{pointer:"#JSSyntax",ep:"syntax",fileexts:["js","json"],name:"js"}],type:"plugins/supported",description:"JavaScript syntax highlighter"},ctags:{resourceURL:"resources/ctags/",description:"Reads and writes tag files",dependencies:{traits:"0.0.0",underscore:"0.0.0"},testmodules:[],type:"plugins/supported",name:"ctags"},events:{resourceURL:"resources/events/",description:"Dead simple event implementation",dependencies:{traits:"0.0"},testmodules:["tests/test"],provides:[],type:"plugins/supported",
name:"events"},theme_manager:{resourceURL:"resources/theme_manager/",name:"theme_manager",share:true,environments:{main:true,worker:false},dependencies:{theme_manager_base:"0.0.0",settings:"0.0.0",events:"0.0.0",less:"0.0.0"},testmodules:[],provides:[{unregister:"themestyles#unregisterThemeStyles",register:"themestyles#registerThemeStyles",ep:"extensionhandler",name:"themestyles"},{unregister:"index#unregisterTheme",register:"index#registerTheme",ep:"extensionhandler",name:"theme"},{defaultValue:"standard",
description:"The theme plugin's name to use. If set to 'standard' no theme will be used",type:"text",ep:"setting",name:"theme"},{pointer:"#appLaunched",ep:"appLaunched"}],type:"plugins/supported",description:"Handles colors in Bespin"},standard_syntax:{resourceURL:"resources/standard_syntax/",description:"Easy-to-use basis for syntax engines",environments:{worker:true},dependencies:{syntax_worker:"0.0.0",syntax_directory:"0.0.0",underscore:"0.0.0"},testmodules:[],type:"plugins/supported",name:"standard_syntax"},
types:{resourceURL:"resources/types/",description:"Defines parameter types for commands",testmodules:["tests/testBasic","tests/testTypes"],provides:[{indexOn:"name",description:"Commands can accept various arguments that the user enters or that are automatically supplied by the environment. Those arguments have types that define how they are supplied or completed. The pointer points to an object with methods convert(str value) and getDefault(). Both functions have `this` set to the command's `takes` parameter. If getDefault is not defined, the default on the command's `takes` is used, if there is one. The object can have a noInput property that is set to true to reflect that this type is provided directly by the system. getDefault must be defined in that case.",
ep:"extensionpoint",name:"type"},{description:"Text that the user needs to enter.",pointer:"basic#text",ep:"type",name:"text"},{description:"A JavaScript number",pointer:"basic#number",ep:"type",name:"number"},{description:"A true/false value",pointer:"basic#bool",ep:"type",name:"boolean"},{description:"An object that converts via JavaScript",pointer:"basic#object",ep:"type",name:"object"},{description:"A string that is constrained to be one of a number of pre-defined values",pointer:"basic#selection",
ep:"type",name:"selection"},{description:"A type which we don't understand from the outset, but which we hope context can help us with",ep:"type",name:"deferred"}],type:"plugins/supported",name:"types"},jquery:{testmodules:[],resourceURL:"resources/jquery/",name:"globaljquery",type:"thirdparty"},embedded:{testmodules:[],dependencies:{theme_manager:"0.0.0",text_editor:"0.0.0",appconfig:"0.0.0",edit_session:"0.0.0",screen_theme:"0.0.0"},resourceURL:"resources/embedded/",name:"embedded",type:"plugins/supported"},
settings:{resourceURL:"resources/settings/",description:"Infrastructure and commands for managing user preferences",share:true,dependencies:{types:"0.0"},testmodules:[],provides:[{description:"Storage for the customizable Bespin settings",pointer:"index#settings",ep:"appcomponent",name:"settings"},{indexOn:"name",description:"A setting is something that the application offers as a way to customize how it works",register:"index#addSetting",ep:"extensionpoint",name:"setting"},{description:"A settingChange is a way to be notified of changes to a setting",
ep:"extensionpoint",name:"settingChange"},{pointer:"commands#setCommand",description:"define and show settings",params:[{defaultValue:null,type:{pointer:"settings:index#getSettings",name:"selection"},name:"setting",description:"The name of the setting to display or alter"},{defaultValue:null,type:{pointer:"settings:index#getTypeSpecFromAssignment",name:"deferred"},name:"value",description:"The new value for the chosen setting"}],ep:"command",name:"set"},{pointer:"commands#unsetCommand",description:"unset a setting entirely",
params:[{type:{pointer:"settings:index#getSettings",name:"selection"},name:"setting",description:"The name of the setting to return to defaults"}],ep:"command",name:"unset"}],type:"plugins/supported",name:"settings"},appconfig:{resourceURL:"resources/appconfig/",description:"Instantiates components and displays the GUI based on configuration.",dependencies:{jquery:"0.0.0",canon:"0.0.0",settings:"0.0.0"},testmodules:[],provides:[{description:"Event: Fired when the app is completely launched.",ep:"extensionpoint",
name:"appLaunched"}],type:"plugins/supported",name:"appconfig"},syntax_worker:{resourceURL:"resources/syntax_worker/",description:"Coordinates multiple syntax engines",environments:{worker:true},dependencies:{syntax_directory:"0.0.0",underscore:"0.0.0"},testmodules:[],type:"plugins/supported",name:"syntax_worker"},screen_theme:{resourceURL:"resources/screen_theme/",description:"Bespins standard theme basePlugin",dependencies:{theme_manager:"0.0.0"},testmodules:[],provides:[{url:["theme.less"],ep:"themestyles"},
{defaultValue:"@global_font",ep:"themevariable",name:"container_font"},{defaultValue:"@global_font_size",ep:"themevariable",name:"container_font_size"},{defaultValue:"@global_container_background",ep:"themevariable",name:"container_bg"},{defaultValue:"@global_color",ep:"themevariable",name:"container_color"},{defaultValue:"@global_line_height",ep:"themevariable",name:"container_line_height"},{defaultValue:"@global_pane_background",ep:"themevariable",name:"pane_bg"},{defaultValue:"@global_pane_border_radius",
ep:"themevariable",name:"pane_border_radius"},{defaultValue:"@global_form_font",ep:"themevariable",name:"form_font"},{defaultValue:"@global_form_font_size",ep:"themevariable",name:"form_font_size"},{defaultValue:"@global_form_line_height",ep:"themevariable",name:"form_line_height"},{defaultValue:"@global_form_color",ep:"themevariable",name:"form_color"},{defaultValue:"@global_form_text_shadow",ep:"themevariable",name:"form_text_shadow"},{defaultValue:"@global_pane_link_color",ep:"themevariable",name:"pane_a_color"},
{defaultValue:"@global_font",ep:"themevariable",name:"pane_font"},{defaultValue:"@global_font_size",ep:"themevariable",name:"pane_font_size"},{defaultValue:"@global_pane_text_shadow",ep:"themevariable",name:"pane_text_shadow"},{defaultValue:"@global_pane_h1_font",ep:"themevariable",name:"pane_h1_font"},{defaultValue:"@global_pane_h1_font_size",ep:"themevariable",name:"pane_h1_font_size"},{defaultValue:"@global_pane_h1_color",ep:"themevariable",name:"pane_h1_color"},{defaultValue:"@global_font_size * 1.8",
ep:"themevariable",name:"pane_line_height"},{defaultValue:"@global_pane_color",ep:"themevariable",name:"pane_color"},{defaultValue:"@global_text_shadow",ep:"themevariable",name:"pane_text_shadow"},{defaultValue:"@global_font",ep:"themevariable",name:"button_font"},{defaultValue:"@global_font_size",ep:"themevariable",name:"button_font_size"},{defaultValue:"@global_button_color",ep:"themevariable",name:"button_color"},{defaultValue:"@global_button_background",ep:"themevariable",name:"button_bg"},{defaultValue:"@button_bg - #063A27",
ep:"themevariable",name:"button_bg2"},{defaultValue:"@button_bg - #194A5E",ep:"themevariable",name:"button_border"},{defaultValue:"@global_control_background",ep:"themevariable",name:"control_bg"},{defaultValue:"@global_control_color",ep:"themevariable",name:"control_color"},{defaultValue:"@global_control_border",ep:"themevariable",name:"control_border"},{defaultValue:"@global_control_border_radius",ep:"themevariable",name:"control_border_radius"},{defaultValue:"@global_control_active_background",
ep:"themevariable",name:"control_active_bg"},{defaultValue:"@global_control_active_border",ep:"themevariable",name:"control_active_border"},{defaultValue:"@global_control_active_color",ep:"themevariable",name:"control_active_color"},{defaultValue:"@global_control_active_inset_color",ep:"themevariable",name:"control_active_inset_color"}],type:"plugins/supported",name:"screen_theme"}})})})();
(function(){var q=bespin.tiki.require("jquery").$,m=function(o,k,h){o=o.style[h]||document.defaultView.getComputedStyle(o,"").getPropertyValue(h);if(!o||o=="auto"||o=="intrinsic")o=k.style[h];return o};bespin.useBespin=function(o,k){var h=bespin.tiki.require("bespin:util/util"),e={},a=e.settings;k=k||{};for(var b in k)e[b]=k[b];k=e.settings;if(a!==undefined)for(b in a)if(k[b]===undefined)e.settings[b]=a[b];var i=null,f=new (bespin.tiki.require("bespin:promise").Promise);bespin.tiki.require.ensurePackage("::appconfig",
function(){var d=bespin.tiki.require("appconfig");if(h.isString(o))o=document.getElementById(o);if(h.none(e.initialContent))e.initialContent=o.value||o.innerHTML;o.innerHTML="";if(o.type=="textarea"){var g=o.parentNode,j=document.createElement("div"),n=function(){var s="position:relative;";["margin-top","margin-left","margin-right","margin-bottom"].forEach(function(x){s+=x+":"+m(o,j,x)+";"});var w=m(o,j,"width"),v=m(o,j,"height");s+="height:"+v+";width:"+w+";";s+="display:inline-block;";j.setAttribute("style",
s)};window.addEventListener("resize",n,false);n();for(o.nextSibling?g.insertBefore(j,o.nextSibling):g.appendChild(j);g!==document;){if(g.tagName.toUpperCase()==="FORM"){var r=g.onsubmit;g.onsubmit=function(s){o.value=i.editor.value;o.innerHTML=i.editor.value;r&&r.call(this,s)};break}g=g.parentNode}o.style.display="none";e.element=j;if(!h.none(o.getAttribute("readonly")))e.readOnly=true}else e.element=o;d.launch(e).then(function(s){i=s;f.resolve(s)})});return f};q(document).ready(function(){for(var o=
[],k=document.querySelectorAll(".bespin"),h=0;h<k.length;h++){var e=k[h],a=e.getAttribute("data-bespinoptions")||"{}";a=bespin.useBespin(e,JSON.parse(a));a.then(function(b){e.bespin=b},function(b){throw new Error("Launch failed: "+b);});o.push(a)}if(window.onBespinLoad){k=bespin.tiki.require("bespin:promise").group;k(o).then(function(){window.onBespinLoad()},function(){throw new Error("At least one Bespin failed to launch!");})}})})();
